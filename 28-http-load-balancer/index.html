
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://tanviralam.com/28-http-load-balancer/">
      
      
        <link rel="prev" href="../27-gcp-elastic-cloud-vpn/">
      
      
        <link rel="next" href="../29-internal-load-balancer/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.15">
    
    
      
        <title>Configuring an HTTP Load Balancer with Autoscaling - Tanvir's Notes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.113286f1.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#configuring-an-http-load-balancer-with-autoscaling" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Tanvir&#39;s Notes" class="md-header__button md-logo" aria-label="Tanvir's Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tanvir's Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Configuring an HTTP Load Balancer with Autoscaling
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Tanvir&#39;s Notes" class="md-nav__button md-logo" aria-label="Tanvir's Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Tanvir's Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome to MkDocs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-linear-algebra-machine-learning/" class="md-nav__link">
        Linear Algebra for Machine Learning
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-git_workflow/" class="md-nav__link">
        Creating a repo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-python-virtual-environments-with-jupyter/" class="md-nav__link">
        What are Python Virtual Environments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04-ecommerce-payments/" class="md-nav__link">
        Structure
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-pubsub-google-clouds/" class="md-nav__link">
        05 pubsub google clouds
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../07-tmux/" class="md-nav__link">
        Tmux
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../08-using-system-clipboard-in-vim/" class="md-nav__link">
        08 using system clipboard in vim
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../09-padi-openwater-sec1/" class="md-nav__link">
        09 padi openwater sec1
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../10-padi-openwater-sec2/" class="md-nav__link">
        10 padi openwater sec2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../11-padi-openwater-sec3/" class="md-nav__link">
        11 padi openwater sec3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../12-padi-openwater-sec3-problem-management/" class="md-nav__link">
        12 padi openwater sec3 problem management
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../13-padi-openwater-sec3-equipment3/" class="md-nav__link">
        13 padi openwater sec3 equipment3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../14-padi-openwater-sec3-skills2/" class="md-nav__link">
        14 padi openwater sec3 skills2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../15-padi-openwater-sec4-equipment4/" class="md-nav__link">
        15 padi openwater sec4 equipment4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../16-padi-openwater-sec4-diver4/" class="md-nav__link">
        16 padi openwater sec4 diver4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../17-padi-openwater-sec4-divecomputers1/" class="md-nav__link">
        17 padi openwater sec4 divecomputers1
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../18-padi-openwater-sec4-skills4/" class="md-nav__link">
        18 padi openwater sec4 skills4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../19-padi-openwater-sec5-divecomputers2/" class="md-nav__link">
        19 padi openwater sec5 divecomputers2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../20-padi-openwater-sec5-diver5/" class="md-nav__link">
        20 padi openwater sec5 diver5
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../21-padi-sec5-skills5/" class="md-nav__link">
        21 padi sec5 skills5
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../22-ubuntu-bluetooth-uninstall-reinstall/" class="md-nav__link">
        22 ubuntu bluetooth uninstall reinstall
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../23-advanced-big-query/" class="md-nav__link">
        Objectives
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../24-freedomticket-week1-intro-to-selling/" class="md-nav__link">
        24 freedomticket week1 intro to selling
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../25-gcp-essential-infrastructure-cloud-sql/" class="md-nav__link">
        Implementing Cloud SQL
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../26-gcp-essential-infrastructure-monitoring/" class="md-nav__link">
        Resource Monitoring
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../27-gcp-elastic-cloud-vpn/" class="md-nav__link">
        Virtual Private Networks (VPN)
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Configuring an HTTP Load Balancer with Autoscaling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Configuring an HTTP Load Balancer with Autoscaling
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-1-configure-a-health-check-firewall-rule" class="md-nav__link">
    Task 1. Configure a health check firewall rule
  </a>
  
    <nav class="md-nav" aria-label="Task 1. Configure a health check firewall rule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-health-check-rule" class="md-nav__link">
    Create the health check rule
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-2-create-a-nat-configuration-using-cloud-router" class="md-nav__link">
    Task 2: Create a NAT configuration using Cloud Router
  </a>
  
    <nav class="md-nav" aria-label="Task 2: Create a NAT configuration using Cloud Router">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-cloud-router-instance" class="md-nav__link">
    Create the Cloud Router instance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-3-create-a-custom-image-for-a-web-server" class="md-nav__link">
    Task 3: Create a custom image for a web server
  </a>
  
    <nav class="md-nav" aria-label="Task 3: Create a custom image for a web server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-vm" class="md-nav__link">
    Create a VM
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customize-the-vm" class="md-nav__link">
    Customize the VM
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-the-apache-service-to-start-at-boot" class="md-nav__link">
    Set the Apache service to start at boot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepare-the-disk-to-create-a-custom-image" class="md-nav__link">
    Prepare the disk to create a custom image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-custom-image" class="md-nav__link">
    Create the custom image
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-4-configure-an-instance-template-and-create-instance-groups" class="md-nav__link">
    Task 4. Configure an instance template and create instance groups
  </a>
  
    <nav class="md-nav" aria-label="Task 4. Configure an instance template and create instance groups">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-the-instance-template" class="md-nav__link">
    Configure the instance template
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-managed-instance-groups" class="md-nav__link">
    Create the managed instance groups
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-5-configure-the-http-load-balancer" class="md-nav__link">
    Task 5. Configure the HTTP load balancer
  </a>
  
    <nav class="md-nav" aria-label="Task 5. Configure the HTTP load balancer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-the-configuration" class="md-nav__link">
    Start the configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-backend" class="md-nav__link">
    Configure the backend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-frontend" class="md-nav__link">
    Configure the frontend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review-and-create-the-http-load-balancer" class="md-nav__link">
    Review and create the HTTP load balancer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-6-stress-test-the-http-load-balancer" class="md-nav__link">
    Task 6. Stress test the HTTP load balancer
  </a>
  
    <nav class="md-nav" aria-label="Task 6. Stress test the HTTP load balancer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#access-the-http-load-balancer" class="md-nav__link">
    Access the HTTP load balancer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stress-test-the-http-load-balancer" class="md-nav__link">
    Stress test the HTTP load balancer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../29-internal-load-balancer/" class="md-nav__link">
        Configuring an Internal Load Balancer
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../30-deployment-manager/" class="md-nav__link">
        Automating the Deployment of Infrastructure Using Deployment Manager
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../31-aws-session/" class="md-nav__link">
        31 aws session
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../32-gcp-cloud-build/" class="md-nav__link">
        32 gcp cloud build
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../33-gcp-deploying-kubernetes/" class="md-nav__link">
        33 gcp deploying kubernetes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../34-gcp-creating-kubernetes-engine-deployments/" class="md-nav__link">
        Creating Google Kubernetes Engine Deployments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../35-gcp-persistent-volume-for-gke/" class="md-nav__link">
        Configuring persistent volume for Google Kubernetes Engine
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../36-gcloud-basics/" class="md-nav__link">
        Basic gcloud commands
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../37-migrate-for-anthos/" class="md-nav__link">
        37 migrate for anthos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../38-kubectl-basics/" class="md-nav__link">
        38 kubectl basics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../39-creating-gke-deployments/" class="md-nav__link">
        39 creating gke deployments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../40-data-reliability-conference/" class="md-nav__link">
        40 data reliability conference
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../41-persistent-storage-gke/" class="md-nav__link">
        Persistent storage in GKE
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../42-creating-gke-deployments-from-shell/" class="md-nav__link">
        42 creating gke deployments from shell
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../43-setting-up-react/" class="md-nav__link">
        Steps to run react in local environment
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../44-redis-with-gcp-cloud-func/" class="md-nav__link">
        44 redis with gcp cloud func
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../45-john-doerr-okr-ted-talk/" class="md-nav__link">
        OKRs
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-1-configure-a-health-check-firewall-rule" class="md-nav__link">
    Task 1. Configure a health check firewall rule
  </a>
  
    <nav class="md-nav" aria-label="Task 1. Configure a health check firewall rule">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-health-check-rule" class="md-nav__link">
    Create the health check rule
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-2-create-a-nat-configuration-using-cloud-router" class="md-nav__link">
    Task 2: Create a NAT configuration using Cloud Router
  </a>
  
    <nav class="md-nav" aria-label="Task 2: Create a NAT configuration using Cloud Router">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-cloud-router-instance" class="md-nav__link">
    Create the Cloud Router instance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-3-create-a-custom-image-for-a-web-server" class="md-nav__link">
    Task 3: Create a custom image for a web server
  </a>
  
    <nav class="md-nav" aria-label="Task 3: Create a custom image for a web server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-a-vm" class="md-nav__link">
    Create a VM
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customize-the-vm" class="md-nav__link">
    Customize the VM
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set-the-apache-service-to-start-at-boot" class="md-nav__link">
    Set the Apache service to start at boot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepare-the-disk-to-create-a-custom-image" class="md-nav__link">
    Prepare the disk to create a custom image
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-custom-image" class="md-nav__link">
    Create the custom image
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-4-configure-an-instance-template-and-create-instance-groups" class="md-nav__link">
    Task 4. Configure an instance template and create instance groups
  </a>
  
    <nav class="md-nav" aria-label="Task 4. Configure an instance template and create instance groups">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-the-instance-template" class="md-nav__link">
    Configure the instance template
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-managed-instance-groups" class="md-nav__link">
    Create the managed instance groups
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-5-configure-the-http-load-balancer" class="md-nav__link">
    Task 5. Configure the HTTP load balancer
  </a>
  
    <nav class="md-nav" aria-label="Task 5. Configure the HTTP load balancer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-the-configuration" class="md-nav__link">
    Start the configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-backend" class="md-nav__link">
    Configure the backend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-frontend" class="md-nav__link">
    Configure the frontend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review-and-create-the-http-load-balancer" class="md-nav__link">
    Review and create the HTTP load balancer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-6-stress-test-the-http-load-balancer" class="md-nav__link">
    Task 6. Stress test the HTTP load balancer
  </a>
  
    <nav class="md-nav" aria-label="Task 6. Stress test the HTTP load balancer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#access-the-http-load-balancer" class="md-nav__link">
    Access the HTTP load balancer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stress-test-the-http-load-balancer" class="md-nav__link">
    Stress test the HTTP load balancer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="configuring-an-http-load-balancer-with-autoscaling">Configuring an HTTP Load Balancer with Autoscaling</h1>
<p>Google Cloud HTTP(S) load balancing is implemented at the edge of Google's network in Google's points of presence (POP) around the world. User traffic directed to an HTTP(S) load balancer enters the POP closest to the user and is then load-balanced over Google's global network to the closest backend that has sufficient available capacity.</p>
<h2 id="objectives">Objectives</h2>
<ol>
<li>Create a health check firewall rule</li>
<li>Create a NAT configuration using Cloud Router</li>
<li>Create a custom image for a web server</li>
<li>Create an instance template based on the custom image</li>
<li>Create two managed instance groups</li>
<li>Configure an HTTP load balancer with IPv4 and IPv6</li>
<li>Stress test an HTTP load balancer</li>
</ol>
<h2 id="task-1-configure-a-health-check-firewall-rule">Task 1. Configure a health check firewall rule</h2>
<p>Health checks determine which instances of a load balancer can receive new connections. For HTTP load balancing, the health check probes to your load-balanced instances come from addresses in the ranges 130.211.0.0/22 and 35.191.0.0/16. Your firewall rules must allow these connections.</p>
<h3 id="create-the-health-check-rule">Create the health check rule</h3>
<p>Create a firewall rule to allow health checks.</p>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click VPC network &gt; Firewall. Notice the existing ICMP, internal, RDP, and SSH firewall rules.</p>
<p>Each Google Cloud project starts with the default network and these firewall rules.</p>
<p>Click Create Firewall Rule.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    fw-allow-health-checks</p>
<p>Network default</p>
<p>Targets Specified target tags</p>
<p>Target tags allow-health-checks</p>
<p>Source filter   IP Ranges</p>
<p>Source IP ranges    130.211.0.0/22 and 35.191.0.0/16</p>
<p>Protocols and ports Specified protocols and ports</p>
<pre><code>Make sure to include the /22 and /16 in the Source IP ranges.
</code></pre>
<p>Select tcp and specify port 80.
Click Create.</p>
<h2 id="task-2-create-a-nat-configuration-using-cloud-router">Task 2: Create a NAT configuration using Cloud Router</h2>
<p>The Google Cloud VM backend instances that you setup in Task 3 will not be configured with external IP addresses.</p>
<p>Instead, you will setup the Cloud NAT service to allow these VM instances to send outbound traffic only through the Cloud NAT, and receive inbound traffic through the load balancer.</p>
<h3 id="create-the-cloud-router-instance">Create the Cloud Router instance</h3>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Network services &gt; Cloud NAT.</p>
<p>Click Get started.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Gateway name    nat-config</p>
<p>Network default</p>
<p>Region  us-central1</p>
<p>Click Cloud Router, and select Create new router.</p>
<p>For Name, type nat-router-us-central1.</p>
<p>Click Create.</p>
<p>In Create a NAT gateway, click Create.</p>
<h2 id="task-3-create-a-custom-image-for-a-web-server">Task 3: Create a custom image for a web server</h2>
<p>Create a custom web server image for the backend of the load balancer.</p>
<h3 id="create-a-vm">Create a VM</h3>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Compute Engine &gt; VM instances.</p>
<p>Click Create Instance.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    webserver</p>
<p>Region  us-central1</p>
<p>Zone    us-central1-a</p>
<p>Series  N1</p>
<p>Machine type    f1-micro (1 vCPU)</p>
<p>Under Boot disk, select change.</p>
<p>click Show advanced option.</p>
<p>Under deletion rule, select keep boot disk</p>
<p>Click Select</p>
<p>Click Networking, disks, security, management, sole-tenancy.</p>
<p>Click Networking.</p>
<pre><code>- For Network tags, type allow-health-checks.
- Under Network interfaces , click default.
- Under External IP dropdown, select None.
</code></pre>
<p>Click Done.</p>
<p>Click Create.</p>
<h3 id="customize-the-vm">Customize the VM</h3>
<p>For webserver, click SSH to launch a terminal and connect.</p>
<p>If you see the Connection via Cloud Identity-Aware Proxy Failed popup, click Retry.</p>
<p>To install Apache2, run the following commands:</p>
<pre><code>sudo apt-get update
sudo apt-get install -y apache2
</code></pre>
<p>To start the Apache server, run the following command:</p>
<pre><code>sudo service apache2 start
</code></pre>
<p>To test the default page for the Apache2 server, run the following command:</p>
<pre><code>curl localhost
</code></pre>
<p>The default page for the Apache2 server should be displayed.</p>
<h3 id="set-the-apache-service-to-start-at-boot">Set the Apache service to start at boot</h3>
<p>The software installation was successful. However, when a new VM is created using this image, the freshly booted VM does not have the Apache web server running. Use the following command to set the Apache service to automatically start on boot. Then test it to make sure it works.</p>
<p>In the webserver SSH terminal, set the service to start on boot:</p>
<pre><code>sudo update-rc.d apache2 enable
</code></pre>
<p>In the Cloud Console, select webserver, and then click Reset.
In the confirmation dialog, click Reset.
Reset will stop and reboot the machine. It keeps the same IPs and the same persistent boot disk, but memory is wiped. Therefore, if the Apache service is available after the reset, the update-rc command was successful.</p>
<p>Check the server by connecting via SSH to the VM and entering the following command:</p>
<pre><code>sudo service apache2 status
</code></pre>
<p>NOTE: If you see the Connection via Cloud Identity-Aware Proxy Failed popup, click Retry .
The result should show Started The Apache HTTP Server.</p>
<h3 id="prepare-the-disk-to-create-a-custom-image">Prepare the disk to create a custom image</h3>
<p>Verify that the boot disk will not be deleted when the instance is deleted.</p>
<p>On the VM instances page, click webserver to view the VM instance details.</p>
<p>Under Boot disk, verify that When deleting instance is set to Keep disk.</p>
<p>Return to the VM instances page, click webserver, and click Delete.</p>
<p>In the confirmation dialog, click Delete.</p>
<p>In the left pane, click Disks and verify that the webserver disk exists.</p>
<h3 id="create-the-custom-image">Create the custom image</h3>
<p>In the left pane, click Images.</p>
<p>Click Create image.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    mywebserver</p>
<p>Source  Disk</p>
<p>Source disk webserver</p>
<p>Click Create.</p>
<p>You have created a custom image that multiple identical webservers can be started from. At this point, you could delete the webserver disk.</p>
<p>The next step is to use that image to define an instance template that can be used in the managed instance groups.</p>
<h2 id="task-4-configure-an-instance-template-and-create-instance-groups">Task 4. Configure an instance template and create instance groups</h2>
<p>A managed instance group uses an instance template to create a group of identical instances. Use these to create the backends of the HTTP load balancer.</p>
<h3 id="configure-the-instance-template">Configure the instance template</h3>
<p>An instance template is an API resource that you can use to create VM instances and managed instance groups. Instance templates define the machine type, boot disk image, subnet, labels, and other instance properties.</p>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Compute Engine &gt; Instance templates.</p>
<p>Click Create instance template.</p>
<p>For Name, type mywebserver-template.</p>
<p>For Series, select N1.</p>
<p>For Machine type, select f1-micro (1 vCPU).</p>
<p>For Boot disk, click Change.</p>
<p>Click Custom images.</p>
<p>For Image, Select mywebserver.</p>
<p>Click Select.</p>
<p>Click Management, security, disks, networking, sole tenancy.</p>
<p>Click Networking.</p>
<pre><code>- For Network tags, type allow-health-checks.
- Under External IP dropdown, select None.
</code></pre>
<p>Click Create.</p>
<h3 id="create-the-managed-instance-groups">Create the managed instance groups</h3>
<p>Create a managed instance group in us-central1 and one in europe-west1.</p>
<p>On the Navigation menu, click Compute Engine &gt; Instance groups.</p>
<p>Click Create Instance group.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    us-central1-mig</p>
<p>Location    Multiple zones</p>
<p>Region  us-central1</p>
<p>Instance template   mywebserver-template</p>
<p>Under Autoscaling metrics, click on the edit pencil icon.</p>
<p>Under Metric type, select HTTP load balancing utilization.</p>
<p>Enter Target HTTP load balancing utilization to 80.</p>
<p>Click Done.</p>
<p>Set Cool down period to 60 seconds.</p>
<p>Enter Minimum number of instances 1 and Maximum number of instances 2.</p>
<pre><code>Managed instance groups offer autoscaling capabilities that allow you to automatically add or remove instances from a managed instance group based on increases or decreases in load. Autoscaling helps your applications gracefully handle increases in traffic and reduces cost when the need for resources is lower. You just define the autoscaling policy, and the autoscaler performs automatic scaling based on the measured load.
</code></pre>
<p>For Health check, select Create a health check.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (select option as specified)</p>
<p>Name    http-health-check</p>
<p>Protocol    TCP</p>
<p>Port    80</p>
<p>Managed instance group health checks proactively signal to delete and recreate instances that become unhealthy.</p>
<p>Click Save and continue.</p>
<p>For Initial delay, type 60. This is how long the Instance Group waits after initializing the boot-up of a VM before it tries a health check. You don't want to wait 5 minutes for this during the lab, so you set it to 1 minute.</p>
<p>Click Create.</p>
<p>Click OK.</p>
<p>NOTE: If a warning window will appear stating that There is no backend service attached to the instance group. Ignore this; you will configure the load balancer with a backend service in the next section of the lab.</p>
<p>Repeat the same procedure for europe-west1-mig in europe-west1:</p>
<p>Click Create Instance group.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    europe-west1-mig</p>
<p>Location    Multiple zones</p>
<p>Region  europe-west1</p>
<p>Instance template   mywebserver-template</p>
<p>Autoscaling metrics &gt; Metric Type   HTTP load balancing utilization</p>
<p>Target HTTP load balancing utilization  80</p>
<p>Minimum number of instances 1</p>
<p>Maximum number of instances 2</p>
<p>Cool down period    60</p>
<p>For Health check, select http-health-check (TCP).</p>
<p>For Initial delay, type 60.</p>
<p>Click Create.</p>
<p>Click OK in the dialog window.</p>
<h2 id="task-5-configure-the-http-load-balancer">Task 5. Configure the HTTP load balancer</h2>
<p>Configure the HTTP load balancer to balance traffic between the two backends (us-central1-mig in us-central1 and europe-west1-mig in europe-west1)</p>
<h3 id="start-the-configuration">Start the configuration</h3>
<p>On the Navigation menu, click Network Services &gt; Load balancing.</p>
<p>Click Create load balancer.</p>
<p>Under HTTP(S) Load Balancing, click Start configuration.</p>
<p>Select From Internet to my VMs, then click Continue.</p>
<p>For Name, type http-lb.</p>
<h3 id="configure-the-backend">Configure the backend</h3>
<p>Backend services direct incoming traffic to one or more attached backends. Each backend is composed of an instance group and additional serving capacity metadata.</p>
<p>Click Backend configuration.</p>
<p>For Backend services &amp; backend buckets, click Create a backend service.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (select option as specified)</p>
<p>Name    http-backend</p>
<p>Backend type    Instance group</p>
<p>Instance group  us-central1-mig</p>
<p>Port numbers    80</p>
<p>Balancing mode  Rate</p>
<p>Maximum RPS 50</p>
<p>Capacity    100</p>
<p>This configuration means that the load balancer attempts to keep each instance of us-central1-mig at or below 50 requests per second (RPS).</p>
<p>Click Done.</p>
<p>Click Add backend.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (select option as specified)</p>
<p>Instance group  europe-west1-mig</p>
<p>Port numbers    80</p>
<p>Balancing mode  Utilization</p>
<p>Maximum backend utilization 80</p>
<p>Capacity    100</p>
<p>This configuration means that the load balancer attempts to keep each instance of europe-west1-mig at or below 80% CPU utilization.</p>
<p>Click Done.</p>
<p>For Health Check, select http-health-check (TCP).</p>
<p>Check the Enable logging checkbox.</p>
<p>Specify Sample rate as 1.</p>
<p>Click Create.</p>
<h3 id="configure-the-frontend">Configure the frontend</h3>
<p>The host and path rules determine how your traffic will be directed. For example, you could direct video traffic to one backend and direct static traffic to another backend. However, you are not configuring the host and path rules in this lab.</p>
<p>Click Frontend configuration.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Protocol    HTTP</p>
<p>IP version  IPv4</p>
<p>IP address  Ephemeral</p>
<p>Port    80</p>
<p>Click Done.</p>
<p>Click Add Frontend IP and port.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Protocol    HTTP</p>
<p>IP version  IPv6</p>
<p>IP address  Ephemeral</p>
<p>Port    80</p>
<p>Click Done.</p>
<p>HTTP(S) load balancing supports both IPv4 and IPv6 addresses for client traffic. Client IPv6 requests are terminated at the global load balancing layer and then proxied over IPv4 to your backends.</p>
<h3 id="review-and-create-the-http-load-balancer">Review and create the HTTP load balancer</h3>
<p>Click Review and finalize.
Review the Backend services and Frontend.
Click Create. Wait for the load balancer to be created.
Click on the name of the load balancer (http-lb).
Note the IPv4 and IPv6 addresses of the load balancer for the next task. They will be referred to as <code>[LB_IP_v4]</code> and <code>[LB_IP_v6]</code>, respectively.
The IPv6 address is the one in hexadecimal format.</p>
<h2 id="task-6-stress-test-the-http-load-balancer">Task 6. Stress test the HTTP load balancer</h2>
<p>Now that you have created the HTTP load balancer for your backends, it is time to verify that traffic is forwarded to the backend service.</p>
<h3 id="access-the-http-load-balancer">Access the HTTP load balancer</h3>
<p>Open a new tab in your browser and navigate to <code>http://[LB_IP_v4]</code>. Make sure to replace <code>[LB_IP_v4]</code> with the IPv4 address of the load balancer.
Accessing the HTTP load balancer might take a couple of minutes. In the meantime, you might get a 404 or 502 error. Keep trying until you see the page of one of the backends.</p>
<h3 id="stress-test-the-http-load-balancer">Stress test the HTTP load balancer</h3>
<p>Create a new VM to simulate a load on the HTTP load balancer. Then determine whether traffic is balanced across both backends when the load is high.</p>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Compute Engine &gt; VM instances.</p>
<p>Click Create instance.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    stress-test</p>
<p>Region  us-west1</p>
<p>Zone    us-west1-c</p>
<p>Series  N1</p>
<p>Machine type    f1-micro (1 vCPU)</p>
<p>Because us-west1 is closer to us-central1 than to europe-west1, traffic should be forwarded only to us-central1-mig (unless the load is too high).</p>
<p>For Boot Disk, click Change.</p>
<p>Click Custom images.</p>
<p>For Image, select mywebserver.</p>
<p>Click Select.</p>
<p>Click Create. Wait for the stress-test instance to be created.</p>
<p>For stress-test, click SSH to launch a terminal and connect.</p>
<p>To create an environment variable for your load balancer IP address, run the following command:</p>
<pre><code>export LB_IP=&lt;Enter your [LB_IP_v4] here&gt;
</code></pre>
<p>Verify it with echo:</p>
<pre><code>echo $LB_IP
</code></pre>
<p>To place a load on the load balancer, run the following command:</p>
<pre><code>ab -n 500000 -c 1000 http://$LB_IP/
</code></pre>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Network Services &gt; Load balancing.</p>
<p>Click Backends.</p>
<p>Click http-backend.</p>
<p>Monitor the Frontend Location (Total inbound traffic) between North America and the two backends for a couple of minutes.</p>
<p>At first, traffic should just be directed to us-central1-mig, but as the RPS increases, traffic is also directed to europe-west1-mig. This demonstrates that by default traffic is forwarded to the closest backend, but if the load is very high, traffic can be distributed across the backends.</p>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Compute Engine &gt; Instance groups.</p>
<p>Click on us-central1-mig to open the instance group page.</p>
<p>Click Observability to monitor the number of instances and LB capacity.</p>
<p>Repeat the same for the europe-west1-mig instance group.</p>
<p>Depending on the load, you might see the backends scale to accommodate the load.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.2a6f1dda.min.js"></script>
      
    
  </body>
</html>