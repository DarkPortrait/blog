<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://tanviralam.com/28-http-load-balancer/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Configuring an HTTP Load Balancer with Autoscaling - Tanvir's Notes</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Configuring an HTTP Load Balancer with Autoscaling";
        var mkdocs_page_input_path = "28-http-load-balancer.md";
        var mkdocs_page_url = "/28-http-load-balancer/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Tanvir's Notes
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Welcome to MkDocs</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../01-linear-algebra-machine-learning/">Linear Algebra for Machine Learning</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../02-git_workflow/">Creating a repo</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../03-python-virtual-environments-with-jupyter/">What are Python Virtual Environments</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../04-ecommerce-payments/">Structure</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../05-pubsub-google-clouds/">05 pubsub google clouds</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../07-tmux/">Tmux</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../08-using-system-clipboard-in-vim/">08 using system clipboard in vim</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../09-padi-openwater-sec1/">09 padi openwater sec1</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../10-padi-openwater-sec2/">10 padi openwater sec2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../11-padi-openwater-sec3/">11 padi openwater sec3</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../12-padi-openwater-sec3-problem-management/">12 padi openwater sec3 problem management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../13-padi-openwater-sec3-equipment3/">13 padi openwater sec3 equipment3</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../14-padi-openwater-sec3-skills2/">14 padi openwater sec3 skills2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../15-padi-openwater-sec4-equipment4/">15 padi openwater sec4 equipment4</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../16-padi-openwater-sec4-diver4/">16 padi openwater sec4 diver4</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../17-padi-openwater-sec4-divecomputers1/">17 padi openwater sec4 divecomputers1</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../18-padi-openwater-sec4-skills4/">18 padi openwater sec4 skills4</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../19-padi-openwater-sec5-divecomputers2/">19 padi openwater sec5 divecomputers2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../20-padi-openwater-sec5-diver5/">20 padi openwater sec5 diver5</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../21-padi-sec5-skills5/">21 padi sec5 skills5</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../22-ubuntu-bluetooth-uninstall-reinstall/">22 ubuntu bluetooth uninstall reinstall</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../23-advanced-big-query/">Objectives</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../24-freedomticket-week1-intro-to-selling/">24 freedomticket week1 intro to selling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../25-gcp-essential-infrastructure-cloud-sql/">Implementing Cloud SQL</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../26-gcp-essential-infrastructure-monitoring/">Resource Monitoring</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../27-gcp-elastic-cloud-vpn/">Virtual Private Networks (VPN)</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Configuring an HTTP Load Balancer with Autoscaling</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#objectives">Objectives</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-1-configure-a-health-check-firewall-rule">Task 1. Configure a health check firewall rule</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#create-the-health-check-rule">Create the health check rule</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-2-create-a-nat-configuration-using-cloud-router">Task 2: Create a NAT configuration using Cloud Router</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#create-the-cloud-router-instance">Create the Cloud Router instance</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-3-create-a-custom-image-for-a-web-server">Task 3: Create a custom image for a web server</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#create-a-vm">Create a VM</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#customize-the-vm">Customize the VM</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#set-the-apache-service-to-start-at-boot">Set the Apache service to start at boot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#prepare-the-disk-to-create-a-custom-image">Prepare the disk to create a custom image</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#create-the-custom-image">Create the custom image</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-4-configure-an-instance-template-and-create-instance-groups">Task 4. Configure an instance template and create instance groups</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#configure-the-instance-template">Configure the instance template</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#create-the-managed-instance-groups">Create the managed instance groups</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-5-configure-the-http-load-balancer">Task 5. Configure the HTTP load balancer</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#start-the-configuration">Start the configuration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configure-the-backend">Configure the backend</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configure-the-frontend">Configure the frontend</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#review-and-create-the-http-load-balancer">Review and create the HTTP load balancer</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-6-stress-test-the-http-load-balancer">Task 6. Stress test the HTTP load balancer</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#access-the-http-load-balancer">Access the HTTP load balancer</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stress-test-the-http-load-balancer">Stress test the HTTP load balancer</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../29-internal-load-balancer/">Configuring an Internal Load Balancer</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../30-deployment-manager/">Automating the Deployment of Infrastructure Using Deployment Manager</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../31-aws-session/">31 aws session</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../32-gcp-cloud-build/">32 gcp cloud build</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../33-gcp-deploying-kubernetes/">33 gcp deploying kubernetes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../34-gcp-creating-kubernetes-engine-deployments/">Creating Google Kubernetes Engine Deployments</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../35-gcp-persistent-volume-for-gke/">Configuring persistent volume for Google Kubernetes Engine</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../36-gcloud-basics/">Basic gcloud commands</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../37-migrate-for-anthos/">37 migrate for anthos</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../38-kubectl-basics/">38 kubectl basics</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../39-creating-gke-deployments/">39 creating gke deployments</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../40-data-reliability-conference/">40 data reliability conference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../41-persistent-storage-gke/">Persistent storage in GKE</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../42-creating-gke-deployments-from-shell/">42 creating gke deployments from shell</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../43-setting-up-react/">Steps to run react in local environment</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../44-redis-with-gcp-cloud-func/">44 redis with gcp cloud func</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Tanvir's Notes</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Configuring an HTTP Load Balancer with Autoscaling</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="configuring-an-http-load-balancer-with-autoscaling">Configuring an HTTP Load Balancer with Autoscaling</h1>
<p>Google Cloud HTTP(S) load balancing is implemented at the edge of Google's network in Google's points of presence (POP) around the world. User traffic directed to an HTTP(S) load balancer enters the POP closest to the user and is then load-balanced over Google's global network to the closest backend that has sufficient available capacity.</p>
<h2 id="objectives">Objectives</h2>
<ol>
<li>Create a health check firewall rule</li>
<li>Create a NAT configuration using Cloud Router</li>
<li>Create a custom image for a web server</li>
<li>Create an instance template based on the custom image</li>
<li>Create two managed instance groups</li>
<li>Configure an HTTP load balancer with IPv4 and IPv6</li>
<li>Stress test an HTTP load balancer</li>
</ol>
<h2 id="task-1-configure-a-health-check-firewall-rule">Task 1. Configure a health check firewall rule</h2>
<p>Health checks determine which instances of a load balancer can receive new connections. For HTTP load balancing, the health check probes to your load-balanced instances come from addresses in the ranges 130.211.0.0/22 and 35.191.0.0/16. Your firewall rules must allow these connections.</p>
<h3 id="create-the-health-check-rule">Create the health check rule</h3>
<p>Create a firewall rule to allow health checks.</p>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click VPC network &gt; Firewall. Notice the existing ICMP, internal, RDP, and SSH firewall rules.</p>
<p>Each Google Cloud project starts with the default network and these firewall rules.</p>
<p>Click Create Firewall Rule.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    fw-allow-health-checks</p>
<p>Network default</p>
<p>Targets Specified target tags</p>
<p>Target tags allow-health-checks</p>
<p>Source filter   IP Ranges</p>
<p>Source IP ranges    130.211.0.0/22 and 35.191.0.0/16</p>
<p>Protocols and ports Specified protocols and ports</p>
<pre><code>Make sure to include the /22 and /16 in the Source IP ranges.
</code></pre>
<p>Select tcp and specify port 80.
Click Create.</p>
<h2 id="task-2-create-a-nat-configuration-using-cloud-router">Task 2: Create a NAT configuration using Cloud Router</h2>
<p>The Google Cloud VM backend instances that you setup in Task 3 will not be configured with external IP addresses.</p>
<p>Instead, you will setup the Cloud NAT service to allow these VM instances to send outbound traffic only through the Cloud NAT, and receive inbound traffic through the load balancer.</p>
<h3 id="create-the-cloud-router-instance">Create the Cloud Router instance</h3>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Network services &gt; Cloud NAT.</p>
<p>Click Get started.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Gateway name    nat-config</p>
<p>Network default</p>
<p>Region  us-central1</p>
<p>Click Cloud Router, and select Create new router.</p>
<p>For Name, type nat-router-us-central1.</p>
<p>Click Create.</p>
<p>In Create a NAT gateway, click Create.</p>
<h2 id="task-3-create-a-custom-image-for-a-web-server">Task 3: Create a custom image for a web server</h2>
<p>Create a custom web server image for the backend of the load balancer.</p>
<h3 id="create-a-vm">Create a VM</h3>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Compute Engine &gt; VM instances.</p>
<p>Click Create Instance.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    webserver</p>
<p>Region  us-central1</p>
<p>Zone    us-central1-a</p>
<p>Series  N1</p>
<p>Machine type    f1-micro (1 vCPU)</p>
<p>Under Boot disk, select change.</p>
<p>click Show advanced option.</p>
<p>Under deletion rule, select keep boot disk</p>
<p>Click Select</p>
<p>Click Networking, disks, security, management, sole-tenancy.</p>
<p>Click Networking.</p>
<pre><code>- For Network tags, type allow-health-checks.
- Under Network interfaces , click default.
- Under External IP dropdown, select None.
</code></pre>
<p>Click Done.</p>
<p>Click Create.</p>
<h3 id="customize-the-vm">Customize the VM</h3>
<p>For webserver, click SSH to launch a terminal and connect.</p>
<p>If you see the Connection via Cloud Identity-Aware Proxy Failed popup, click Retry.</p>
<p>To install Apache2, run the following commands:</p>
<pre><code>sudo apt-get update
sudo apt-get install -y apache2
</code></pre>
<p>To start the Apache server, run the following command:</p>
<pre><code>sudo service apache2 start
</code></pre>
<p>To test the default page for the Apache2 server, run the following command:</p>
<pre><code>curl localhost
</code></pre>
<p>The default page for the Apache2 server should be displayed.</p>
<h3 id="set-the-apache-service-to-start-at-boot">Set the Apache service to start at boot</h3>
<p>The software installation was successful. However, when a new VM is created using this image, the freshly booted VM does not have the Apache web server running. Use the following command to set the Apache service to automatically start on boot. Then test it to make sure it works.</p>
<p>In the webserver SSH terminal, set the service to start on boot:</p>
<pre><code>sudo update-rc.d apache2 enable
</code></pre>
<p>In the Cloud Console, select webserver, and then click Reset.
In the confirmation dialog, click Reset.
Reset will stop and reboot the machine. It keeps the same IPs and the same persistent boot disk, but memory is wiped. Therefore, if the Apache service is available after the reset, the update-rc command was successful.</p>
<p>Check the server by connecting via SSH to the VM and entering the following command:</p>
<pre><code>sudo service apache2 status
</code></pre>
<p>NOTE: If you see the Connection via Cloud Identity-Aware Proxy Failed popup, click Retry .
The result should show Started The Apache HTTP Server.</p>
<h3 id="prepare-the-disk-to-create-a-custom-image">Prepare the disk to create a custom image</h3>
<p>Verify that the boot disk will not be deleted when the instance is deleted.</p>
<p>On the VM instances page, click webserver to view the VM instance details.</p>
<p>Under Boot disk, verify that When deleting instance is set to Keep disk.</p>
<p>Return to the VM instances page, click webserver, and click Delete.</p>
<p>In the confirmation dialog, click Delete.</p>
<p>In the left pane, click Disks and verify that the webserver disk exists.</p>
<h3 id="create-the-custom-image">Create the custom image</h3>
<p>In the left pane, click Images.</p>
<p>Click Create image.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    mywebserver</p>
<p>Source  Disk</p>
<p>Source disk webserver</p>
<p>Click Create.</p>
<p>You have created a custom image that multiple identical webservers can be started from. At this point, you could delete the webserver disk.</p>
<p>The next step is to use that image to define an instance template that can be used in the managed instance groups.</p>
<h2 id="task-4-configure-an-instance-template-and-create-instance-groups">Task 4. Configure an instance template and create instance groups</h2>
<p>A managed instance group uses an instance template to create a group of identical instances. Use these to create the backends of the HTTP load balancer.</p>
<h3 id="configure-the-instance-template">Configure the instance template</h3>
<p>An instance template is an API resource that you can use to create VM instances and managed instance groups. Instance templates define the machine type, boot disk image, subnet, labels, and other instance properties.</p>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Compute Engine &gt; Instance templates.</p>
<p>Click Create instance template.</p>
<p>For Name, type mywebserver-template.</p>
<p>For Series, select N1.</p>
<p>For Machine type, select f1-micro (1 vCPU).</p>
<p>For Boot disk, click Change.</p>
<p>Click Custom images.</p>
<p>For Image, Select mywebserver.</p>
<p>Click Select.</p>
<p>Click Management, security, disks, networking, sole tenancy.</p>
<p>Click Networking.</p>
<pre><code>- For Network tags, type allow-health-checks.
- Under External IP dropdown, select None.
</code></pre>
<p>Click Create.</p>
<h3 id="create-the-managed-instance-groups">Create the managed instance groups</h3>
<p>Create a managed instance group in us-central1 and one in europe-west1.</p>
<p>On the Navigation menu, click Compute Engine &gt; Instance groups.</p>
<p>Click Create Instance group.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    us-central1-mig</p>
<p>Location    Multiple zones</p>
<p>Region  us-central1</p>
<p>Instance template   mywebserver-template</p>
<p>Under Autoscaling metrics, click on the edit pencil icon.</p>
<p>Under Metric type, select HTTP load balancing utilization.</p>
<p>Enter Target HTTP load balancing utilization to 80.</p>
<p>Click Done.</p>
<p>Set Cool down period to 60 seconds.</p>
<p>Enter Minimum number of instances 1 and Maximum number of instances 2.</p>
<pre><code>Managed instance groups offer autoscaling capabilities that allow you to automatically add or remove instances from a managed instance group based on increases or decreases in load. Autoscaling helps your applications gracefully handle increases in traffic and reduces cost when the need for resources is lower. You just define the autoscaling policy, and the autoscaler performs automatic scaling based on the measured load.
</code></pre>
<p>For Health check, select Create a health check.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (select option as specified)</p>
<p>Name    http-health-check</p>
<p>Protocol    TCP</p>
<p>Port    80</p>
<p>Managed instance group health checks proactively signal to delete and recreate instances that become unhealthy.</p>
<p>Click Save and continue.</p>
<p>For Initial delay, type 60. This is how long the Instance Group waits after initializing the boot-up of a VM before it tries a health check. You don't want to wait 5 minutes for this during the lab, so you set it to 1 minute.</p>
<p>Click Create.</p>
<p>Click OK.</p>
<p>NOTE: If a warning window will appear stating that There is no backend service attached to the instance group. Ignore this; you will configure the load balancer with a backend service in the next section of the lab.</p>
<p>Repeat the same procedure for europe-west1-mig in europe-west1:</p>
<p>Click Create Instance group.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    europe-west1-mig</p>
<p>Location    Multiple zones</p>
<p>Region  europe-west1</p>
<p>Instance template   mywebserver-template</p>
<p>Autoscaling metrics &gt; Metric Type   HTTP load balancing utilization</p>
<p>Target HTTP load balancing utilization  80</p>
<p>Minimum number of instances 1</p>
<p>Maximum number of instances 2</p>
<p>Cool down period    60</p>
<p>For Health check, select http-health-check (TCP).</p>
<p>For Initial delay, type 60.</p>
<p>Click Create.</p>
<p>Click OK in the dialog window.</p>
<h2 id="task-5-configure-the-http-load-balancer">Task 5. Configure the HTTP load balancer</h2>
<p>Configure the HTTP load balancer to balance traffic between the two backends (us-central1-mig in us-central1 and europe-west1-mig in europe-west1)</p>
<h3 id="start-the-configuration">Start the configuration</h3>
<p>On the Navigation menu, click Network Services &gt; Load balancing.</p>
<p>Click Create load balancer.</p>
<p>Under HTTP(S) Load Balancing, click Start configuration.</p>
<p>Select From Internet to my VMs, then click Continue.</p>
<p>For Name, type http-lb.</p>
<h3 id="configure-the-backend">Configure the backend</h3>
<p>Backend services direct incoming traffic to one or more attached backends. Each backend is composed of an instance group and additional serving capacity metadata.</p>
<p>Click Backend configuration.</p>
<p>For Backend services &amp; backend buckets, click Create a backend service.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (select option as specified)</p>
<p>Name    http-backend</p>
<p>Backend type    Instance group</p>
<p>Instance group  us-central1-mig</p>
<p>Port numbers    80</p>
<p>Balancing mode  Rate</p>
<p>Maximum RPS 50</p>
<p>Capacity    100</p>
<p>This configuration means that the load balancer attempts to keep each instance of us-central1-mig at or below 50 requests per second (RPS).</p>
<p>Click Done.</p>
<p>Click Add backend.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (select option as specified)</p>
<p>Instance group  europe-west1-mig</p>
<p>Port numbers    80</p>
<p>Balancing mode  Utilization</p>
<p>Maximum backend utilization 80</p>
<p>Capacity    100</p>
<p>This configuration means that the load balancer attempts to keep each instance of europe-west1-mig at or below 80% CPU utilization.</p>
<p>Click Done.</p>
<p>For Health Check, select http-health-check (TCP).</p>
<p>Check the Enable logging checkbox.</p>
<p>Specify Sample rate as 1.</p>
<p>Click Create.</p>
<h3 id="configure-the-frontend">Configure the frontend</h3>
<p>The host and path rules determine how your traffic will be directed. For example, you could direct video traffic to one backend and direct static traffic to another backend. However, you are not configuring the host and path rules in this lab.</p>
<p>Click Frontend configuration.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Protocol    HTTP</p>
<p>IP version  IPv4</p>
<p>IP address  Ephemeral</p>
<p>Port    80</p>
<p>Click Done.</p>
<p>Click Add Frontend IP and port.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Protocol    HTTP</p>
<p>IP version  IPv6</p>
<p>IP address  Ephemeral</p>
<p>Port    80</p>
<p>Click Done.</p>
<p>HTTP(S) load balancing supports both IPv4 and IPv6 addresses for client traffic. Client IPv6 requests are terminated at the global load balancing layer and then proxied over IPv4 to your backends.</p>
<h3 id="review-and-create-the-http-load-balancer">Review and create the HTTP load balancer</h3>
<p>Click Review and finalize.
Review the Backend services and Frontend.
Click Create. Wait for the load balancer to be created.
Click on the name of the load balancer (http-lb).
Note the IPv4 and IPv6 addresses of the load balancer for the next task. They will be referred to as <code>[LB_IP_v4]</code> and <code>[LB_IP_v6]</code>, respectively.
The IPv6 address is the one in hexadecimal format.</p>
<h2 id="task-6-stress-test-the-http-load-balancer">Task 6. Stress test the HTTP load balancer</h2>
<p>Now that you have created the HTTP load balancer for your backends, it is time to verify that traffic is forwarded to the backend service.</p>
<h3 id="access-the-http-load-balancer">Access the HTTP load balancer</h3>
<p>Open a new tab in your browser and navigate to <code>http://[LB_IP_v4]</code>. Make sure to replace <code>[LB_IP_v4]</code> with the IPv4 address of the load balancer.
Accessing the HTTP load balancer might take a couple of minutes. In the meantime, you might get a 404 or 502 error. Keep trying until you see the page of one of the backends.</p>
<h3 id="stress-test-the-http-load-balancer">Stress test the HTTP load balancer</h3>
<p>Create a new VM to simulate a load on the HTTP load balancer. Then determine whether traffic is balanced across both backends when the load is high.</p>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Compute Engine &gt; VM instances.</p>
<p>Click Create instance.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    stress-test</p>
<p>Region  us-west1</p>
<p>Zone    us-west1-c</p>
<p>Series  N1</p>
<p>Machine type    f1-micro (1 vCPU)</p>
<p>Because us-west1 is closer to us-central1 than to europe-west1, traffic should be forwarded only to us-central1-mig (unless the load is too high).</p>
<p>For Boot Disk, click Change.</p>
<p>Click Custom images.</p>
<p>For Image, select mywebserver.</p>
<p>Click Select.</p>
<p>Click Create. Wait for the stress-test instance to be created.</p>
<p>For stress-test, click SSH to launch a terminal and connect.</p>
<p>To create an environment variable for your load balancer IP address, run the following command:</p>
<pre><code>export LB_IP=&lt;Enter your [LB_IP_v4] here&gt;
</code></pre>
<p>Verify it with echo:</p>
<pre><code>echo $LB_IP
</code></pre>
<p>To place a load on the load balancer, run the following command:</p>
<pre><code>ab -n 500000 -c 1000 http://$LB_IP/
</code></pre>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Network Services &gt; Load balancing.</p>
<p>Click Backends.</p>
<p>Click http-backend.</p>
<p>Monitor the Frontend Location (Total inbound traffic) between North America and the two backends for a couple of minutes.</p>
<p>At first, traffic should just be directed to us-central1-mig, but as the RPS increases, traffic is also directed to europe-west1-mig. This demonstrates that by default traffic is forwarded to the closest backend, but if the load is very high, traffic can be distributed across the backends.</p>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Compute Engine &gt; Instance groups.</p>
<p>Click on us-central1-mig to open the instance group page.</p>
<p>Click Observability to monitor the number of instances and LB capacity.</p>
<p>Repeat the same for the europe-west1-mig instance group.</p>
<p>Depending on the load, you might see the backends scale to accommodate the load.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../27-gcp-elastic-cloud-vpn/" class="btn btn-neutral float-left" title="Virtual Private Networks (VPN)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../29-internal-load-balancer/" class="btn btn-neutral float-right" title="Configuring an Internal Load Balancer">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../27-gcp-elastic-cloud-vpn/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../29-internal-load-balancer/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
