
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://tanviralam.com/29-internal-load-balancer/">
      
      
        <link rel="prev" href="../28-http-load-balancer/">
      
      
        <link rel="next" href="../30-deployment-manager/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.15">
    
    
      
        <title>Configuring an Internal Load Balancer - Tanvir's Notes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.113286f1.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#configuring-an-internal-load-balancer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Tanvir&#39;s Notes" class="md-header__button md-logo" aria-label="Tanvir's Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tanvir's Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Configuring an Internal Load Balancer
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Tanvir&#39;s Notes" class="md-nav__button md-logo" aria-label="Tanvir's Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Tanvir's Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome to MkDocs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-linear-algebra-machine-learning/" class="md-nav__link">
        Linear Algebra for Machine Learning
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-git_workflow/" class="md-nav__link">
        Creating a repo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-python-virtual-environments-with-jupyter/" class="md-nav__link">
        What are Python Virtual Environments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04-ecommerce-payments/" class="md-nav__link">
        Structure
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-pubsub-google-clouds/" class="md-nav__link">
        05 pubsub google clouds
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../07-tmux/" class="md-nav__link">
        Tmux
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../08-using-system-clipboard-in-vim/" class="md-nav__link">
        08 using system clipboard in vim
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../09-padi-openwater-sec1/" class="md-nav__link">
        09 padi openwater sec1
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../10-padi-openwater-sec2/" class="md-nav__link">
        10 padi openwater sec2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../11-padi-openwater-sec3/" class="md-nav__link">
        11 padi openwater sec3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../12-padi-openwater-sec3-problem-management/" class="md-nav__link">
        12 padi openwater sec3 problem management
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../13-padi-openwater-sec3-equipment3/" class="md-nav__link">
        13 padi openwater sec3 equipment3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../14-padi-openwater-sec3-skills2/" class="md-nav__link">
        14 padi openwater sec3 skills2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../15-padi-openwater-sec4-equipment4/" class="md-nav__link">
        15 padi openwater sec4 equipment4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../16-padi-openwater-sec4-diver4/" class="md-nav__link">
        16 padi openwater sec4 diver4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../17-padi-openwater-sec4-divecomputers1/" class="md-nav__link">
        17 padi openwater sec4 divecomputers1
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../18-padi-openwater-sec4-skills4/" class="md-nav__link">
        18 padi openwater sec4 skills4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../19-padi-openwater-sec5-divecomputers2/" class="md-nav__link">
        19 padi openwater sec5 divecomputers2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../20-padi-openwater-sec5-diver5/" class="md-nav__link">
        20 padi openwater sec5 diver5
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../21-padi-sec5-skills5/" class="md-nav__link">
        21 padi sec5 skills5
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../22-ubuntu-bluetooth-uninstall-reinstall/" class="md-nav__link">
        22 ubuntu bluetooth uninstall reinstall
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../23-advanced-big-query/" class="md-nav__link">
        Objectives
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../24-freedomticket-week1-intro-to-selling/" class="md-nav__link">
        24 freedomticket week1 intro to selling
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../25-gcp-essential-infrastructure-cloud-sql/" class="md-nav__link">
        Implementing Cloud SQL
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../26-gcp-essential-infrastructure-monitoring/" class="md-nav__link">
        Resource Monitoring
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../27-gcp-elastic-cloud-vpn/" class="md-nav__link">
        Virtual Private Networks (VPN)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../28-http-load-balancer/" class="md-nav__link">
        Configuring an HTTP Load Balancer with Autoscaling
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Configuring an Internal Load Balancer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Configuring an Internal Load Balancer
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#task-1-configure-internal-traffic-and-health-check-firewall-rules" class="md-nav__link">
    Task 1. Configure internal traffic and health check firewall rules.
  </a>
  
    <nav class="md-nav" aria-label="Task 1. Configure internal traffic and health check firewall rules.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#explore-the-my-internal-app-network" class="md-nav__link">
    Explore the my-internal-app network
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-firewall-rule-to-allow-traffic-from-any-sources-in-the-10100016-range" class="md-nav__link">
    Create the firewall rule to allow traffic from any sources in the 10.10.0.0/16 range
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-health-check-rule" class="md-nav__link">
    Create the health check rule
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-2-create-a-nat-configuration-using-cloud-router" class="md-nav__link">
    Task 2: Create a NAT configuration using Cloud Router
  </a>
  
    <nav class="md-nav" aria-label="Task 2: Create a NAT configuration using Cloud Router">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-cloud-router-instance" class="md-nav__link">
    Create the Cloud Router instance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-3-configure-instance-templates-and-create-instance-groups" class="md-nav__link">
    Task 3. Configure instance templates and create instance groups
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-the-instance-templates" class="md-nav__link">
    Configure the instance templates
  </a>
  
    <nav class="md-nav" aria-label="Configure the instance templates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-managed-instance-groups" class="md-nav__link">
    Create the managed instance groups
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-the-backends" class="md-nav__link">
    Verify the backends
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-4-configure-the-internal-load-balancer" class="md-nav__link">
    Task 4. Configure the internal load balancer
  </a>
  
    <nav class="md-nav" aria-label="Task 4. Configure the internal load balancer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-the-configuration" class="md-nav__link">
    Start the configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-regional-backend-service" class="md-nav__link">
    Configure the regional backend service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-frontend" class="md-nav__link">
    Configure the frontend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review-and-create-the-internal-load-balancer" class="md-nav__link">
    Review and create the internal load balancer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-5-test-the-internal-load-balancer" class="md-nav__link">
    Task 5. Test the internal load balancer
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../30-deployment-manager/" class="md-nav__link">
        Automating the Deployment of Infrastructure Using Deployment Manager
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../31-aws-session/" class="md-nav__link">
        31 aws session
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../32-gcp-cloud-build/" class="md-nav__link">
        32 gcp cloud build
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../33-gcp-deploying-kubernetes/" class="md-nav__link">
        33 gcp deploying kubernetes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../34-gcp-creating-kubernetes-engine-deployments/" class="md-nav__link">
        Creating Google Kubernetes Engine Deployments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../35-gcp-persistent-volume-for-gke/" class="md-nav__link">
        Configuring persistent volume for Google Kubernetes Engine
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../36-gcloud-basics/" class="md-nav__link">
        Basic gcloud commands
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../37-migrate-for-anthos/" class="md-nav__link">
        37 migrate for anthos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../38-kubectl-basics/" class="md-nav__link">
        38 kubectl basics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../39-creating-gke-deployments/" class="md-nav__link">
        39 creating gke deployments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../40-data-reliability-conference/" class="md-nav__link">
        40 data reliability conference
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../41-persistent-storage-gke/" class="md-nav__link">
        Persistent storage in GKE
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../42-creating-gke-deployments-from-shell/" class="md-nav__link">
        42 creating gke deployments from shell
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../43-setting-up-react/" class="md-nav__link">
        Steps to run react in local environment
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../44-redis-with-gcp-cloud-func/" class="md-nav__link">
        44 redis with gcp cloud func
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../45-john-doerr-okr-ted-talk/" class="md-nav__link">
        OKRs
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#task-1-configure-internal-traffic-and-health-check-firewall-rules" class="md-nav__link">
    Task 1. Configure internal traffic and health check firewall rules.
  </a>
  
    <nav class="md-nav" aria-label="Task 1. Configure internal traffic and health check firewall rules.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#explore-the-my-internal-app-network" class="md-nav__link">
    Explore the my-internal-app network
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-firewall-rule-to-allow-traffic-from-any-sources-in-the-10100016-range" class="md-nav__link">
    Create the firewall rule to allow traffic from any sources in the 10.10.0.0/16 range
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-health-check-rule" class="md-nav__link">
    Create the health check rule
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-2-create-a-nat-configuration-using-cloud-router" class="md-nav__link">
    Task 2: Create a NAT configuration using Cloud Router
  </a>
  
    <nav class="md-nav" aria-label="Task 2: Create a NAT configuration using Cloud Router">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-cloud-router-instance" class="md-nav__link">
    Create the Cloud Router instance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-3-configure-instance-templates-and-create-instance-groups" class="md-nav__link">
    Task 3. Configure instance templates and create instance groups
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-the-instance-templates" class="md-nav__link">
    Configure the instance templates
  </a>
  
    <nav class="md-nav" aria-label="Configure the instance templates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-managed-instance-groups" class="md-nav__link">
    Create the managed instance groups
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-the-backends" class="md-nav__link">
    Verify the backends
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-4-configure-the-internal-load-balancer" class="md-nav__link">
    Task 4. Configure the internal load balancer
  </a>
  
    <nav class="md-nav" aria-label="Task 4. Configure the internal load balancer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-the-configuration" class="md-nav__link">
    Start the configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-regional-backend-service" class="md-nav__link">
    Configure the regional backend service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-frontend" class="md-nav__link">
    Configure the frontend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review-and-create-the-internal-load-balancer" class="md-nav__link">
    Review and create the internal load balancer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-5-test-the-internal-load-balancer" class="md-nav__link">
    Task 5. Test the internal load balancer
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="configuring-an-internal-load-balancer">Configuring an Internal Load Balancer</h1>
<h2 id="task-1-configure-internal-traffic-and-health-check-firewall-rules">Task 1. Configure internal traffic and health check firewall rules.</h2>
<p>Configure firewall rules to allow internal traffic connectivity from sources in the 10.10.0.0/16 range. This rule allows incoming traffic from any client located in the subnet.</p>
<p>Health checks determine which instances of a load balancer can receive new connections. For HTTP load balancing, the health check probes to your load-balanced instances come from addresses in the ranges 130.211.0.0/22 and 35.191.0.0/16. Your firewall rules must allow these connections.</p>
<h3 id="explore-the-my-internal-app-network">Explore the my-internal-app network</h3>
<p>The network my-internal-app with subnet-a and subnet-b and firewall rules for RDP, SSH, and ICMP traffic have been configured for you.</p>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click VPC network &gt; VPC networks. Notice the my-internal-app network with its subnets: subnet-a and subnet-b.</p>
<p>Each Google Cloud project starts with the default network. In addition, the my-internal-app network has been created for you as part of your network diagram.</p>
<p>You will create the managed instance groups in subnet-a and subnet-b. Both subnets are in the us-central1 region because an internal load balancer is a regional service. The managed instance groups will be in different zones, making your service immune to zonal failures.</p>
<h3 id="create-the-firewall-rule-to-allow-traffic-from-any-sources-in-the-10100016-range">Create the firewall rule to allow traffic from any sources in the 10.10.0.0/16 range</h3>
<p>Create a firewall rule to allow traffic in the 10.10.0.0/16 subnet.</p>
<p>On the Navigation menu (Navigation menu), click VPC network &gt; Firewall. Notice the app-allow-icmp and app-allow-ssh-rdp firewall rules.</p>
<p>These firewall rules have been created for you.</p>
<p>Click Create Firewall Rule.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    fw-allow-lb-access</p>
<p>Network my-internal-app</p>
<p>Targets Specified target tags</p>
<p>Target tags backend-service</p>
<p>Source filter   IP ranges</p>
<p>Source IP ranges    10.10.0.0/16</p>
<p>Protocols and ports Allow all</p>
<p>Click create.</p>
<h3 id="create-the-health-check-rule">Create the health check rule</h3>
<p>Create a firewall rule to allow health checks.</p>
<p>On the Navigation menu (Navigation menu), click VPC network &gt; Firewall.</p>
<p>Click Create Firewall Rule.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    fw-allow-health-checks</p>
<p>Network my-internal-app</p>
<p>Targets Specified target tags</p>
<p>Target tags backend-service</p>
<p>Source filter   IP Ranges</p>
<p>Source IP ranges    130.211.0.0/22 and 35.191.0.0/16</p>
<p>Protocols and ports Specified protocols and ports</p>
<p>Make sure to include the /22 and /16 in the Source IP ranges.</p>
<p>For tcp, specify port 80.</p>
<p>Click Create.</p>
<h2 id="task-2-create-a-nat-configuration-using-cloud-router">Task 2: Create a NAT configuration using Cloud Router</h2>
<p>The Google Cloud VM backend instances that you setup in Task 3 will not be configured with external IP addresses.</p>
<p>Instead, you will setup the Cloud NAT service to allow these VM instances to send outbound traffic only through the Cloud NAT, and receive inbound traffic through the load balancer.</p>
<h3 id="create-the-cloud-router-instance">Create the Cloud Router instance</h3>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Network services &gt; Cloud NAT.</p>
<p>Click Get started.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Gateway name    nat-config</p>
<p>VPC network my-internal-app</p>
<p>Region  us-central1</p>
<p>Click Cloud Router, and select Create new router.</p>
<p>For Name, type nat-router-us-central1.</p>
<p>Click Create.</p>
<p>In Create a NAT gateway, click Create.</p>
<p>Wait until the NAT Gateway Status changes to Running before moving onto the next task.</p>
<h2 id="task-3-configure-instance-templates-and-create-instance-groups">Task 3. Configure instance templates and create instance groups</h2>
<p>A managed instance group uses an instance template to create a group of identical instances. Use these to create the backends of the internal load balancer.</p>
<h2 id="configure-the-instance-templates">Configure the instance templates</h2>
<p>An instance template is an API resource that you can use to create VM instances and managed instance groups. Instance templates define the machine type, boot disk image, subnet, labels, and other instance properties. Create an instance template for both subnets of the my-internal-app network.</p>
<p>On the Navigation menu (Navigation menu), click Compute Engine &gt; Instance templates.</p>
<p>Click Create instance template.</p>
<p>For Name, type instance-template-1</p>
<p>Under Machine configuration, For Series, Select N1.</p>
<p>Machine type f1-micro(1 vCPU).</p>
<p>Click Management, security, disks, networking, sole tenancy.</p>
<p>Click Management.</p>
<p>Under Metadata, specify the following:</p>
<p>Key Value</p>
<p>startup-script-url  gs://cloud-training/gcpnet/ilb/startup.sh</p>
<p>The startup-script-url specifies a script that is executed when instances are started. This script installs Apache and changes the welcome page to include the client IP and the name, region, and zone of the VM instance. You can explore this script here.</p>
<pre><code>#! /bin/bash

apt-get update 
apt-get install -y apache2 php
apt-get install -y wget
cd /var/www/html
rm index.html -f
rm index.php -f
wget https://storage.googleapis.com/cloud-training/gcpnet/ilb/index.php
META_REGION_STRING=$(curl &quot;http://metadata.google.internal/computeMetadata/v1/instance/zone&quot; -H &quot;Metadata-Flavor: Google&quot;)
REGION=`echo &quot;$META_REGION_STRING&quot; | awk -F/ '{print $4}'`
sed -i &quot;s|region-here|$REGION|&quot; index.php
</code></pre>
<p>Click Networking.</p>
<p>For Network interfaces, specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Network my-internal-app</p>
<p>Subnet  subnet-a</p>
<p>Network tags    backend-service</p>
<p>External IP None</p>
<p>The network tag backend-service ensures that the firewall rule to allow traffic from any sources in the 10.10.0.0/16 subnet and the Health Check firewall rule applies to these instances.</p>
<p>Click Create. Wait for the instance template to be created.</p>
<p>Create another instance template for subnet-b by copying instance-template-1:</p>
<p>Select the instance-template-1 and click Copy.</p>
<p>Click Management, security, disks, networking, sole tenancy.</p>
<p>Click Networking.</p>
<p>For Network interfaces, select subnet-b as the Subnet.</p>
<p>Click Create.</p>
<h3 id="create-the-managed-instance-groups">Create the managed instance groups</h3>
<p>Create a managed instance group in subnet-a (us-central1-a) and subnet-b (us-central1-b).</p>
<p>On the Navigation menu (Navigation menu), click Compute Engine &gt; Instance groups.</p>
<p>Click Create Instance group.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    instance-group-1</p>
<p>Location    Single zone</p>
<p>Region  us-central1</p>
<p>Zone    us-central1-a</p>
<p>Instance template   instance-template-1</p>
<p>Autoscaling &gt; metrics type (Click the pencil edit icon) CPU utilization</p>
<p>Target CPU utilization  80, click Done.</p>
<p>Cool-down period    45</p>
<p>Minimum number of instances 1</p>
<p>Maximum number of instances 5</p>
<p>Managed instance groups offer autoscaling capabilities that allow you to automatically add or remove instances from a managed instance group based on increases or decreases in load. Autoscaling helps your applications gracefully handle increases in traffic and reduces cost when the need for resources is lower. Just define the autoscaling policy, and the autoscaler performs automatic scaling based on the measured load.</p>
<p>Click Create.</p>
<p>Repeat the same procedure for instance-group-2 in us-central1-b:</p>
<p>Click Create Instance group.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    instance-group-2</p>
<p>Location    Single zone</p>
<p>Region  us-central1</p>
<p>Zone    us-central1-b</p>
<p>Instance template   instance-template-2</p>
<p>Autoscaling &gt; metric type (Click the pencil edit icon)  CPU utilization</p>
<p>Target CPU utilization  80, click Done.</p>
<p>Cool-down period    45</p>
<p>Minimum number of instances 1</p>
<p>Maximum number of instances 5</p>
<p>Click Create.</p>
<h2 id="verify-the-backends">Verify the backends</h2>
<p>Verify that VM instances are being created in both subnets and create a utility VM to access the backends' HTTP sites.</p>
<p>On the Navigation menu, click Compute Engine &gt; VM instances. Notice two instances that start with instance-group-1 and instance-group-2.</p>
<p>These instances are in separate zones, and their internal IP addresses are part of the subnet-a and subnet-b CIDR blocks.</p>
<p>Click Create Instance.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    utility-vm</p>
<p>Region  us-central1</p>
<p>Zone    us-central1-f</p>
<p>Series  N1</p>
<p>Machine type    f1-micro (1 vCPU)</p>
<p>Boot disk   Debian GNU/Linux 10 (buster)</p>
<p>Click Management, security, disks, networking, sole tenancy.</p>
<p>Click Networking.</p>
<p>For Network interfaces, click the pencil icon to edit.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Network my-internal-app</p>
<p>Subnetwork  subnet-a</p>
<p>Primary internal IP Ephemeral (Custom)</p>
<p>Custom ephemeral IP address 10.10.20.50</p>
<p>External IP None</p>
<p>Click Done.</p>
<p>Click Create.</p>
<p>Note that the internal IP addresses for the backends are 10.10.20.2 and 10.10.30.2.</p>
<p>If these IP addresses are different, replace them in the two curl commands below.</p>
<p>For utility-vm, click SSH to launch a terminal and connect. If you see the Connection via Cloud Identity-Aware Proxy Failed popup, click Retry.</p>
<p>To verify the welcome page for instance-group-1-xxxx, run the following command:</p>
<pre><code>curl 10.10.20.2
</code></pre>
<p>The output should look like this (do not copy; this is example output):</p>
<pre><code>&lt;h1&gt;Internal Load Balancing Lab&lt;/h1&gt;&lt;h2&gt;Client IP&lt;/h2&gt;Your IP address : 10.10.20.50&lt;h2&gt;Hostname&lt;/h2&gt;Server Hostname:
 instance-group-1-1zn8&lt;h2&gt;Server Location&lt;/h2&gt;Region and Zone: us-central1-a
</code></pre>
<p>To verify the welcome page for instance-group-2-xxxx, run the following command:</p>
<pre><code>curl 10.10.30.2
</code></pre>
<p>The output should look like this (do not copy; this is example output):</p>
<pre><code>&lt;h1&gt;Internal Load Balancing Lab&lt;/h1&gt;&lt;h2&gt;Client IP&lt;/h2&gt;Your IP address : 10.10.20.50&lt;h2&gt;Hostname&lt;/h2&gt;Server Hostname:
 instance-group-2-q5wp&lt;h2&gt;Server Location&lt;/h2&gt;Region and Zone: us-central1-b
</code></pre>
<p>This will be useful when verifying that the internal load balancer sends traffic to both backends.</p>
<p>Close the SSH terminal to utility-vm</p>
<h2 id="task-4-configure-the-internal-load-balancer">Task 4. Configure the internal load balancer</h2>
<p>Configure the internal load balancer to balance traffic between the two backends (instance-group-1 in us-central1-a and instance-group-2 in us-central1-b)</p>
<h3 id="start-the-configuration">Start the configuration</h3>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click Network Services &gt; Load balancing.
Click Create load balancer.
Under TCP Load Balancing, click Start configuration.
For Internet facing or internal only, select Only between my VMs.
Choosing Only between my VMs makes this load balancer internal. This choice requires the backends to be in a single region (us-central1) and does not allow offloading TCP processing to the load balancer.</p>
<p>Click Continue.</p>
<p>For Name, type my-ilb.</p>
<h3 id="configure-the-regional-backend-service">Configure the regional backend service</h3>
<p>The backend service monitors instance groups and prevents them from exceeding configured usage.</p>
<p>Click Backend configuration.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (select option as specified)</p>
<p>Region  us-central1</p>
<p>Network my-internal-app</p>
<p>Instance group  instance-group-1 (us-central1-a)</p>
<p>Click Done.</p>
<p>Click Add backend.</p>
<p>For Instance group, select instance-group-2 (us-central1-b).</p>
<p>Click Done.</p>
<p>For Health Check, select Create a health check.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (select option as specified)</p>
<p>Name    my-ilb-health-check</p>
<p>Protocol    TCP</p>
<p>Port    80</p>
<p>Check interval  10 sec</p>
<p>Timeout 5 sec</p>
<p>Healthy threshold   2</p>
<p>Unhealthy threshold 3</p>
<p>Health checks determine which instances can receive new connections. This HTTP health check polls instances every 10 seconds, waits up to 5 seconds for a response, and treats 2 successful or 3 failed attempts as healthy threshold or unhealthy threshold, respectively.</p>
<p>Click Save and continue.</p>
<p>Verify that there is a blue check mark next to Backend configuration in the Cloud Console. If there isn't, double-check that you have completed all the steps above.</p>
<h3 id="configure-the-frontend">Configure the frontend</h3>
<p>The frontend forwards traffic to the backend.</p>
<p>Click Frontend configuration.</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Subnetwork  subnet-b</p>
<p>Internal IP &gt; IP address    Reserve static internal IP address</p>
<p>Specify the following, and leave the remaining settings as their defaults:</p>
<p>Property    Value (type value or select option as specified)</p>
<p>Name    my-ilb-ip</p>
<p>Static IP address   Let me choose</p>
<p>Custom IP address   10.10.30.5</p>
<p>Click Reserve.</p>
<p>For Ports, type 80.</p>
<p>Click Done.</p>
<h3 id="review-and-create-the-internal-load-balancer">Review and create the internal load balancer</h3>
<p>Click Review and finalize.
Review the Backend and Frontend.
Click Create. Wait for the load balancer to be created before moving to the next task.</p>
<h2 id="task-5-test-the-internal-load-balancer">Task 5. Test the internal load balancer</h2>
<p>Verify that the my-ilb IP address forwards traffic to instance-group-1 in us-central1-a and instance-group-2 in us-central1-b.</p>
<p>Access the internal load balancer
On the Navigation menu, click Compute Engine &gt; VM instances.</p>
<p>For utility-vm, click SSH to launch a terminal and connect.</p>
<p>To verify that the internal load balancer forwards traffic, run the following command:</p>
<pre><code>curl 10.10.30.5
</code></pre>
<p>The output should look like this (do not copy; this is example output):</p>
<pre><code>&lt;h1&gt;Internal Load Balancing Lab&lt;/h1&gt;&lt;h2&gt;Client IP&lt;/h2&gt;Your IP address : 10.10.20.50&lt;h2&gt;Hostname&lt;/h2&gt;Server Hostname:
 instance-group-2-1zn8&lt;h2&gt;Server Location&lt;/h2&gt;Region and Zone: us-central1-b
</code></pre>
<p>As expected, traffic is forwarded from the internal load balancer (10.10.30.5) to the backend.</p>
<p>Run the same command a couple of times</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.2a6f1dda.min.js"></script>
      
    
  </body>
</html>