
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://tanviralam.com/41-persistent-storage-gke/">
      
      
        <link rel="prev" href="../40-data-reliability-conference/">
      
      
        <link rel="next" href="../42-creating-gke-deployments-from-shell/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.15">
    
    
      
        <title>Persistent storage in GKE - Tanvir's Notes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.113286f1.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#persistent-storage-in-gke" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Tanvir&#39;s Notes" class="md-header__button md-logo" aria-label="Tanvir's Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tanvir's Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Persistent storage in GKE
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Tanvir&#39;s Notes" class="md-nav__button md-logo" aria-label="Tanvir's Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Tanvir's Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome to MkDocs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-linear-algebra-machine-learning/" class="md-nav__link">
        Linear Algebra for Machine Learning
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-git_workflow/" class="md-nav__link">
        Creating a repo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-python-virtual-environments-with-jupyter/" class="md-nav__link">
        What are Python Virtual Environments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04-ecommerce-payments/" class="md-nav__link">
        Structure
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-pubsub-google-clouds/" class="md-nav__link">
        05 pubsub google clouds
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../07-tmux/" class="md-nav__link">
        Tmux
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../08-using-system-clipboard-in-vim/" class="md-nav__link">
        08 using system clipboard in vim
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../09-padi-openwater-sec1/" class="md-nav__link">
        09 padi openwater sec1
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../10-padi-openwater-sec2/" class="md-nav__link">
        10 padi openwater sec2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../11-padi-openwater-sec3/" class="md-nav__link">
        11 padi openwater sec3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../12-padi-openwater-sec3-problem-management/" class="md-nav__link">
        12 padi openwater sec3 problem management
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../13-padi-openwater-sec3-equipment3/" class="md-nav__link">
        13 padi openwater sec3 equipment3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../14-padi-openwater-sec3-skills2/" class="md-nav__link">
        14 padi openwater sec3 skills2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../15-padi-openwater-sec4-equipment4/" class="md-nav__link">
        15 padi openwater sec4 equipment4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../16-padi-openwater-sec4-diver4/" class="md-nav__link">
        16 padi openwater sec4 diver4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../17-padi-openwater-sec4-divecomputers1/" class="md-nav__link">
        17 padi openwater sec4 divecomputers1
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../18-padi-openwater-sec4-skills4/" class="md-nav__link">
        18 padi openwater sec4 skills4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../19-padi-openwater-sec5-divecomputers2/" class="md-nav__link">
        19 padi openwater sec5 divecomputers2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../20-padi-openwater-sec5-diver5/" class="md-nav__link">
        20 padi openwater sec5 diver5
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../21-padi-sec5-skills5/" class="md-nav__link">
        21 padi sec5 skills5
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../22-ubuntu-bluetooth-uninstall-reinstall/" class="md-nav__link">
        22 ubuntu bluetooth uninstall reinstall
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../23-advanced-big-query/" class="md-nav__link">
        Objectives
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../24-freedomticket-week1-intro-to-selling/" class="md-nav__link">
        24 freedomticket week1 intro to selling
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../25-gcp-essential-infrastructure-cloud-sql/" class="md-nav__link">
        Implementing Cloud SQL
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../26-gcp-essential-infrastructure-monitoring/" class="md-nav__link">
        Resource Monitoring
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../27-gcp-elastic-cloud-vpn/" class="md-nav__link">
        Virtual Private Networks (VPN)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../28-http-load-balancer/" class="md-nav__link">
        Configuring an HTTP Load Balancer with Autoscaling
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../29-internal-load-balancer/" class="md-nav__link">
        Configuring an Internal Load Balancer
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../30-deployment-manager/" class="md-nav__link">
        Automating the Deployment of Infrastructure Using Deployment Manager
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../31-aws-session/" class="md-nav__link">
        31 aws session
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../32-gcp-cloud-build/" class="md-nav__link">
        32 gcp cloud build
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../33-gcp-deploying-kubernetes/" class="md-nav__link">
        33 gcp deploying kubernetes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../34-gcp-creating-kubernetes-engine-deployments/" class="md-nav__link">
        Creating Google Kubernetes Engine Deployments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../35-gcp-persistent-volume-for-gke/" class="md-nav__link">
        Configuring persistent volume for Google Kubernetes Engine
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../36-gcloud-basics/" class="md-nav__link">
        Basic gcloud commands
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../37-migrate-for-anthos/" class="md-nav__link">
        37 migrate for anthos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../38-kubectl-basics/" class="md-nav__link">
        38 kubectl basics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../39-creating-gke-deployments/" class="md-nav__link">
        39 creating gke deployments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../40-data-reliability-conference/" class="md-nav__link">
        40 data reliability conference
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Persistent storage in GKE
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Persistent storage in GKE
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#task-1-create-pvs-and-pvcs" class="md-nav__link">
    Task 1. Create PVs and PVCs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect-to-the-lab-gke-cluster" class="md-nav__link">
    Connect to the lab GKE cluster
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-and-apply-a-manifest-with-a-pvc" class="md-nav__link">
    Create and apply a manifest with a PVC
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-2-mount-and-verify-google-cloud-persistent-disk-pvcs-in-pods" class="md-nav__link">
    Task 2. Mount and verify Google Cloud persistent disk PVCs in Pods
  </a>
  
    <nav class="md-nav" aria-label="Task 2. Mount and verify Google Cloud persistent disk PVCs in Pods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mount-the-pvc-to-a-pod" class="md-nav__link">
    Mount the PVC to a Pod
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-the-persistence-of-the-pv" class="md-nav__link">
    Test the persistence of the PV
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-3-create-statefulsets-with-pvcs" class="md-nav__link">
    Task 3. Create StatefulSets with PVCs
  </a>
  
    <nav class="md-nav" aria-label="Task 3. Create StatefulSets with PVCs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#release-the-pvc" class="md-nav__link">
    Release the PVC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-statefulset" class="md-nav__link">
    Create a StatefulSet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-the-connection-of-pods-in-statefulsets" class="md-nav__link">
    Verify the connection of Pods in StatefulSets
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-4-verify-the-persistence-of-persistent-volume-connections-to-pods-managed-by-statefulsets" class="md-nav__link">
    Task 4. Verify the persistence of Persistent Volume connections to Pods managed by StatefulSets
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../42-creating-gke-deployments-from-shell/" class="md-nav__link">
        42 creating gke deployments from shell
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../43-setting-up-react/" class="md-nav__link">
        Steps to run react in local environment
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../44-redis-with-gcp-cloud-func/" class="md-nav__link">
        44 redis with gcp cloud func
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../45-john-doerr-okr-ted-talk/" class="md-nav__link">
        OKRs
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#task-1-create-pvs-and-pvcs" class="md-nav__link">
    Task 1. Create PVs and PVCs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect-to-the-lab-gke-cluster" class="md-nav__link">
    Connect to the lab GKE cluster
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-and-apply-a-manifest-with-a-pvc" class="md-nav__link">
    Create and apply a manifest with a PVC
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-2-mount-and-verify-google-cloud-persistent-disk-pvcs-in-pods" class="md-nav__link">
    Task 2. Mount and verify Google Cloud persistent disk PVCs in Pods
  </a>
  
    <nav class="md-nav" aria-label="Task 2. Mount and verify Google Cloud persistent disk PVCs in Pods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mount-the-pvc-to-a-pod" class="md-nav__link">
    Mount the PVC to a Pod
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-the-persistence-of-the-pv" class="md-nav__link">
    Test the persistence of the PV
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-3-create-statefulsets-with-pvcs" class="md-nav__link">
    Task 3. Create StatefulSets with PVCs
  </a>
  
    <nav class="md-nav" aria-label="Task 3. Create StatefulSets with PVCs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#release-the-pvc" class="md-nav__link">
    Release the PVC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-statefulset" class="md-nav__link">
    Create a StatefulSet
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-the-connection-of-pods-in-statefulsets" class="md-nav__link">
    Verify the connection of Pods in StatefulSets
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-4-verify-the-persistence-of-persistent-volume-connections-to-pods-managed-by-statefulsets" class="md-nav__link">
    Task 4. Verify the persistence of Persistent Volume connections to Pods managed by StatefulSets
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="persistent-storage-in-gke">Persistent storage in GKE</h1>
<h3 id="task-1-create-pvs-and-pvcs">Task 1. Create PVs and PVCs</h3>
<p>In this task, you create a PVC, which triggers Kubernetes to automatically create a PV.</p>
<h3 id="connect-to-the-lab-gke-cluster">Connect to the lab GKE cluster</h3>
<p>In Cloud Shell, type the following command to set the environment variable for the zone and cluster name.</p>
<pre><code>export my_zone=us-central1-a
export my_cluster=standard-cluster-1
</code></pre>
<p>Configure tab completion for the kubectl command-line tool.</p>
<pre><code>source &lt;(kubectl completion bash)
</code></pre>
<p>Configure access to your cluster for kubectl:</p>
<pre><code>gcloud container clusters get-credentials $my_cluster --zone $my_zone
</code></pre>
<h3 id="create-and-apply-a-manifest-with-a-pvc">Create and apply a manifest with a PVC</h3>
<p>Most of the time, you don't need to directly configure PV objects or create Compute Engine persistent disks. Instead, you can create a PVC, and Kubernetes automatically provisions a persistent disk for you.</p>
<p>You create the PVC in this task using the pvc-demo.yaml manifest file that has been provided for you. This creates a 30 gigabyte PVC called hello-web-disk that can be mounted as a read-write volume on a single node at a time.</p>
<pre><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: hello-web-disk
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 30Gi
</code></pre>
<p>In Cloud Shell, enter the following command to clone the repository to the lab Cloud Shell.</p>
<pre><code>git clone https://github.com/GoogleCloudPlatform/training-data-analyst
</code></pre>
<p>Create a soft link as a shortcut to the working directory.</p>
<pre><code>ln -s ~/training-data-analyst/courses/ak8s/v1.1 ~/ak8s
</code></pre>
<p>Change to the directory that contains the sample files for this lab.</p>
<pre><code>cd ~/ak8s/Storage/
</code></pre>
<p>To show that you currently have no PVCs, execute the following command:</p>
<pre><code>kubectl get persistentvolumeclaim
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>No resources found in default namespace.
</code></pre>
<p>To create the PVC, execute the following command:</p>
<pre><code>kubectl apply -f pvc-demo.yaml
</code></pre>
<p>To show your newly created PVC, execute the following command:</p>
<pre><code>kubectl get persistentvolumeclaim
</code></pre>
<p>Partial output (Do not copy):</p>
<pre><code>NAME           STATUS VOLUME        CAP   ACCESS MODES      CLASS   AGE
hello-web-disk Bound  pvc-8...34   30Gi            RWO   standard    5s
</code></pre>
<h2 id="task-2-mount-and-verify-google-cloud-persistent-disk-pvcs-in-pods">Task 2. Mount and verify Google Cloud persistent disk PVCs in Pods</h2>
<p>In this task, you attach your persistent disk PVC to a Pod. You mount the PVC as a volume as part of the manifest for the Pod.</p>
<h3 id="mount-the-pvc-to-a-pod">Mount the PVC to a Pod</h3>
<p>The manifest file pod-volume-demo.yaml deploys an nginx container, attaches the pvc-demo-volume to the Pod and mounts that volume to the path /var/www/html inside the nginx container. Files saved to this directory inside the container will be saved to the persistent volume and persist even if the Pod and the container are shutdown and recreated.</p>
<pre><code>kind: Pod
apiVersion: v1
metadata:
  name: pvc-demo-pod
spec:
  containers:
    - name: frontend
      image: nginx
      volumeMounts:
      - mountPath: &quot;/var/www/html&quot;
        name: pvc-demo-volume
  volumes:
    - name: pvc-demo-volume
      persistentVolumeClaim:
        claimName: hello-web-disk
</code></pre>
<p>To create the Pod with the volume, execute the following command:</p>
<pre><code>kubectl apply -f pod-volume-demo.yaml
</code></pre>
<p>List the Pods in the cluster.</p>
<pre><code>kubectl get pods
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>NAME          READY    STATUS              RESTARTS   AGE
pvc-demo-pod  0/1      ContainerCreating   0          18s
</code></pre>
<p>If you do this quickly after creating the Pod, you will see the status listed as "ContainerCreating" while the volume is mounted before the status changes to "Running".</p>
<p>To verify the PVC is accessible within the Pod, you must gain shell access to your Pod. To start the shell session, execute the following command:</p>
<pre><code>kubectl exec -it pvc-demo-pod -- sh
</code></pre>
<p>To create a simple text message as a web page in the Pod enter the following commands:</p>
<pre><code>echo Test webpage in a persistent volume!&gt;/var/www/html/index.html
chmod +x /var/www/html/index.html
</code></pre>
<p>Verify the text file contains your message.</p>
<pre><code>cat /var/www/html/index.html
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>Test webpage in a persistent volume!
</code></pre>
<p>Enter the following command to leave the interactive shell on the nginx container.</p>
<pre><code>exit
</code></pre>
<h3 id="test-the-persistence-of-the-pv">Test the persistence of the PV</h3>
<p>You will now delete the Pod from the cluster, confirm that the PV still exists, then redeploy the Pod and verify the contents of the PV remain intact.</p>
<p>Delete the pvc-demo-pod.</p>
<pre><code>kubectl delete pod pvc-demo-pod
</code></pre>
<p>List the Pods in the cluster.</p>
<pre><code>kubectl get pods
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>No resources found in default namespace.
</code></pre>
<p>There should be no Pods on the cluster.</p>
<p>To show your PVC, execute the following command:</p>
<pre><code>kubectl get persistentvolumeclaim
</code></pre>
<p>Partial output (Do not copy):</p>
<pre><code>NAME           STATUS VOLUME        CAP   ACCESS MODES      CLASS   AGE
hello-web-disk Bound  pvc-8...34   30Gi            RWO   standard   22m
</code></pre>
<p>Your PVC still exists, and was not deleted when the Pod was deleted.</p>
<p>Redeploy the pvc-demo-pod.</p>
<pre><code>kubectl apply -f pod-volume-demo.yaml
</code></pre>
<p>List the Pods in the cluster.</p>
<pre><code>kubectl get pods
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>NAME           READY     STATUS    RESTARTS   AGE
pvc-demo-pod   1/1       Running   0          15s
</code></pre>
<p>The Pod will deploy and the status will change to "Running" faster this time because the PV already exists and does not need to be created.</p>
<p>To verify the PVC is still accessible within the Pod, you must gain shell access to your Pod. To start the shell session, execute the following command:</p>
<pre><code>kubectl exec -it pvc-demo-pod -- sh
</code></pre>
<p>To verify that the text file still contains your message execute the following command:</p>
<pre><code>cat /var/www/html/index.html
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>Test webpage in a persistent volume!
</code></pre>
<p>The contents of the persistent volume were not removed, even though the Pod was deleted from the cluster and recreated.</p>
<p>Enter the following command to leave the interactive shell on the nginx container.</p>
<pre><code>exit
</code></pre>
<h2 id="task-3-create-statefulsets-with-pvcs">Task 3. Create StatefulSets with PVCs</h2>
<p>In this task, you use your PVC in a StatefulSet. A StatefulSet is like a Deployment, except that the Pods are given unique identifiers.</p>
<h3 id="release-the-pvc">Release the PVC</h3>
<p>Before you can use the PVC with the statefulset, you must delete the Pod that is currently using it. Execute the following command to delete the Pod:</p>
<pre><code>kubectl delete pod pvc-demo-pod
</code></pre>
<p>Confirm the Pod has been removed.</p>
<pre><code>kubectl get pods
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>No resources found in default namespace.
</code></pre>
<h3 id="create-a-statefulset">Create a StatefulSet</h3>
<p>The manifest file statefulset-demo.yaml creates a StatefulSet that includes a LoadBalancer service and three replicas of a Pod containing an nginx container and a volumeClaimTemplate for 30 gigabyte PVCs with the name hello-web-disk. The nginx containers mount the PVC called hello-web-disk at /var/www/html as in the previous task.</p>
<pre><code>kind: Service
apiVersion: v1
metadata:
  name: statefulset-demo-service
spec:
  ports:
  - protocol: TCP
    port: 80
    targetPort: 9376
  type: LoadBalancer
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: statefulset-demo
spec:
  selector:
    matchLabels:
      app: MyApp
  serviceName: statefulset-demo-service
  replicas: 3
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: MyApp
    spec:
      containers:
      - name: stateful-set-container
        image: nginx
        ports:
        - containerPort: 80
          name: http
        volumeMounts:
        - name: hello-web-disk
          mountPath: &quot;/var/www/html&quot;
  volumeClaimTemplates:
  - metadata:
      name: hello-web-disk
    spec:
      accessModes: [ &quot;ReadWriteOnce&quot; ]
      resources:
        requests:
          storage: 30Gi
</code></pre>
<p>To create the StatefulSet with the volume, execute the following command:</p>
<pre><code>kubectl apply -f statefulset-demo.yaml
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>service &quot;statefulset-demo-service&quot; created
statefulset.apps &quot;statefulset-demo&quot; created
</code></pre>
<p>You now have a statefulset running behind a service named statefulset-demo-service.</p>
<h3 id="verify-the-connection-of-pods-in-statefulsets">Verify the connection of Pods in StatefulSets</h3>
<p>Use "kubectl describe" to view the details of the StatefulSet:</p>
<pre><code>kubectl describe statefulset statefulset-demo
</code></pre>
<p>Note the event status at the end of the output. The service and statefulset created successfully.</p>
<pre><code>Normal  SuccessfulCreate  10s   statefulset-controller
Message: create Claim hello-web-disk-statefulset-demo-0 Pod statefulset-demo-0 in StatefulSet statefulset-demo success
Normal  SuccessfulCreate  10s   statefulset-controller
Message: create Pod statefulset-demo-0 in StatefulSet statefulset-demo successful
</code></pre>
<p>List the Pods in the cluster.</p>
<pre><code>kubectl get pods
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>NAME                 READY     STATUS    RESTARTS   AGE
statefulset-demo-0   1/1       Running   0          6m
statefulset-demo-1   1/1       Running   0          3m
statefulset-demo-2   1/1       Running   0          2m
</code></pre>
<p>To list the PVCs, execute the following command:</p>
<pre><code>kubectl get pvc
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>NAME                          STATUS    VOLUME           CAPACITY ACCESS
hello-web-disk                Bound     pvc-86117ea6-...34   30Gi    RWO
hello-web-disk-st...-demo-0   Bound     pvc-92d21d0f-...34   30Gi    RWO
hello-web-disk-st...-demo-1   Bound     pvc-9bc84d92-...34   30Gi    RWO
hello-web-disk-st...-demo-2   Bound     pvc-a526ecdf-...34   30Gi    RWO
</code></pre>
<p>The original hello-web-disk is still there and you can now see the individual PVCs that were created for each Pod in the new statefulset Pod.</p>
<p>Use "kubectl describe" to view the details of the first PVC in the StatefulSet:</p>
<pre><code>kubectl describe pvc hello-web-disk-statefulset-demo-0
</code></pre>
<h2 id="task-4-verify-the-persistence-of-persistent-volume-connections-to-pods-managed-by-statefulsets">Task 4. Verify the persistence of Persistent Volume connections to Pods managed by StatefulSets</h2>
<p>In this task, you verify the connection of Pods in StatefulSets to particular PVs as the Pods are stopped and restarted.</p>
<p>To verify that the PVC is accessible within the Pod, you must gain shell access to your Pod. To start the shell session, execute the following command:</p>
<pre><code>kubectl exec -it statefulset-demo-0 -- sh
</code></pre>
<p>Verify that there is no index.html text file in the /var/www/html directory.</p>
<pre><code>cat /var/www/html/index.html
</code></pre>
<p>To create a simple text message as a web page in the Pod enter the following commands:</p>
<pre><code>echo Test webpage in a persistent volume!&gt;/var/www/html/index.html
chmod +x /var/www/html/index.html
</code></pre>
<p>Verify the text file contains your message.</p>
<pre><code>cat /var/www/html/index.html
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>Test webpage in a persistent volume!
</code></pre>
<p>Enter the following command to leave the interactive shell on the nginx container.</p>
<pre><code>exit
</code></pre>
<p>Delete the Pod where you updated the file on the PVC.</p>
<pre><code>kubectl delete pod statefulset-demo-0
</code></pre>
<p>List the Pods in the cluster.</p>
<pre><code>kubectl get pods
</code></pre>
<p>You will see that the StatefulSet is automatically restarting the statefulset-demo-0 Pod.</p>
<p>Note: You need to wait until the Pod status shows that it is running again.</p>
<p>Connect to the shell on the new statefulset-demo-0 Pod.</p>
<pre><code>kubectl exec -it statefulset-demo-0 -- sh
</code></pre>
<p>Verify that the text file still contains your message.</p>
<pre><code>cat /var/www/html/index.html
</code></pre>
<p>Output (Do not copy):</p>
<pre><code>Test webpage in a persistent volume!
</code></pre>
<p>The StatefulSet restarts the Pod and reconnects the existing dedicated PVC to the new Pod, ensuring that the data for that Pod is preserved.</p>
<p>Enter the following command to leave the interactive shell on the nginx container.</p>
<pre><code>exit
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.2a6f1dda.min.js"></script>
      
    
  </body>
</html>