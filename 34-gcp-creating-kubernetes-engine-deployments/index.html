
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://tanviralam.com/34-gcp-creating-kubernetes-engine-deployments/">
      
      
        <link rel="prev" href="../33-gcp-deploying-kubernetes/">
      
      
        <link rel="next" href="../35-gcp-persistent-volume-for-gke/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.15">
    
    
      
        <title>Creating Google Kubernetes Engine Deployments - Tanvir's Notes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.113286f1.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#creating-google-kubernetes-engine-deployments" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Tanvir&#39;s Notes" class="md-header__button md-logo" aria-label="Tanvir's Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Tanvir's Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Creating Google Kubernetes Engine Deployments
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Tanvir&#39;s Notes" class="md-nav__button md-logo" aria-label="Tanvir's Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Tanvir's Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome to MkDocs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-linear-algebra-machine-learning/" class="md-nav__link">
        Linear Algebra for Machine Learning
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-git_workflow/" class="md-nav__link">
        Creating a repo
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-python-virtual-environments-with-jupyter/" class="md-nav__link">
        What are Python Virtual Environments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04-ecommerce-payments/" class="md-nav__link">
        Structure
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-pubsub-google-clouds/" class="md-nav__link">
        05 pubsub google clouds
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../07-tmux/" class="md-nav__link">
        Tmux
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../08-using-system-clipboard-in-vim/" class="md-nav__link">
        08 using system clipboard in vim
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../09-padi-openwater-sec1/" class="md-nav__link">
        09 padi openwater sec1
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../10-padi-openwater-sec2/" class="md-nav__link">
        10 padi openwater sec2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../11-padi-openwater-sec3/" class="md-nav__link">
        11 padi openwater sec3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../12-padi-openwater-sec3-problem-management/" class="md-nav__link">
        12 padi openwater sec3 problem management
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../13-padi-openwater-sec3-equipment3/" class="md-nav__link">
        13 padi openwater sec3 equipment3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../14-padi-openwater-sec3-skills2/" class="md-nav__link">
        14 padi openwater sec3 skills2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../15-padi-openwater-sec4-equipment4/" class="md-nav__link">
        15 padi openwater sec4 equipment4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../16-padi-openwater-sec4-diver4/" class="md-nav__link">
        16 padi openwater sec4 diver4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../17-padi-openwater-sec4-divecomputers1/" class="md-nav__link">
        17 padi openwater sec4 divecomputers1
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../18-padi-openwater-sec4-skills4/" class="md-nav__link">
        18 padi openwater sec4 skills4
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../19-padi-openwater-sec5-divecomputers2/" class="md-nav__link">
        19 padi openwater sec5 divecomputers2
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../20-padi-openwater-sec5-diver5/" class="md-nav__link">
        20 padi openwater sec5 diver5
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../21-padi-sec5-skills5/" class="md-nav__link">
        21 padi sec5 skills5
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../22-ubuntu-bluetooth-uninstall-reinstall/" class="md-nav__link">
        22 ubuntu bluetooth uninstall reinstall
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../23-advanced-big-query/" class="md-nav__link">
        Objectives
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../24-freedomticket-week1-intro-to-selling/" class="md-nav__link">
        24 freedomticket week1 intro to selling
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../25-gcp-essential-infrastructure-cloud-sql/" class="md-nav__link">
        Implementing Cloud SQL
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../26-gcp-essential-infrastructure-monitoring/" class="md-nav__link">
        Resource Monitoring
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../27-gcp-elastic-cloud-vpn/" class="md-nav__link">
        Virtual Private Networks (VPN)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../28-http-load-balancer/" class="md-nav__link">
        Configuring an HTTP Load Balancer with Autoscaling
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../29-internal-load-balancer/" class="md-nav__link">
        Configuring an Internal Load Balancer
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../30-deployment-manager/" class="md-nav__link">
        Automating the Deployment of Infrastructure Using Deployment Manager
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../31-aws-session/" class="md-nav__link">
        31 aws session
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../32-gcp-cloud-build/" class="md-nav__link">
        32 gcp cloud build
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../33-gcp-deploying-kubernetes/" class="md-nav__link">
        33 gcp deploying kubernetes
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Creating Google Kubernetes Engine Deployments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Creating Google Kubernetes Engine Deployments
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    Objectives
  </a>
  
    <nav class="md-nav" aria-label="Objectives">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#activate-cloud-shell" class="md-nav__link">
    Activate cloud shell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-1-create-deployment-manifests-and-deploy-to-the-cluster" class="md-nav__link">
    Task 1. Create deployment manifests and deploy to the cluster
  </a>
  
    <nav class="md-nav" aria-label="Task 1. Create deployment manifests and deploy to the cluster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-to-the-lab-gke-cluster" class="md-nav__link">
    Connect to the lab GKE cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-deployment-manifest" class="md-nav__link">
    Create a deployment manifest
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-2-manually-scale-up-and-down-the-number-of-pods-in-deployments" class="md-nav__link">
    Task 2. Manually scale up and down the number of Pods in deployments
  </a>
  
    <nav class="md-nav" aria-label="Task 2. Manually scale up and down the number of Pods in deployments">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scale-pods-up-and-down-in-the-console" class="md-nav__link">
    Scale Pods up and down in the console
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scale-pods-up-and-down-in-the-shell" class="md-nav__link">
    Scale Pods up and down in the shell
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-3-trigger-a-deployment-rollout-and-a-deployment-rollback" class="md-nav__link">
    Task 3. Trigger a deployment rollout and a deployment rollback
  </a>
  
    <nav class="md-nav" aria-label="Task 3. Trigger a deployment rollout and a deployment rollback">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trigger-a-deployment-rollout" class="md-nav__link">
    Trigger a deployment rollout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-the-rollout-history-of-the-deployment" class="md-nav__link">
    View the rollout history of the deployment.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trigger-a-deployment-rollback" class="md-nav__link">
    Trigger a deployment rollback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-service-types-in-the-manifest" class="md-nav__link">
    Define service types in the manifest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-the-loadbalancer-creation" class="md-nav__link">
    Verify the LoadBalancer creation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-5-perform-a-canary-deployment" class="md-nav__link">
    Task 5. Perform a canary deployment
  </a>
  
    <nav class="md-nav" aria-label="Task 5. Perform a canary deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#session-affinity" class="md-nav__link">
    Session affinity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../35-gcp-persistent-volume-for-gke/" class="md-nav__link">
        Configuring persistent volume for Google Kubernetes Engine
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../36-gcloud-basics/" class="md-nav__link">
        Basic gcloud commands
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../37-migrate-for-anthos/" class="md-nav__link">
        37 migrate for anthos
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../38-kubectl-basics/" class="md-nav__link">
        38 kubectl basics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../39-creating-gke-deployments/" class="md-nav__link">
        39 creating gke deployments
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../40-data-reliability-conference/" class="md-nav__link">
        40 data reliability conference
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../41-persistent-storage-gke/" class="md-nav__link">
        Persistent storage in GKE
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../42-creating-gke-deployments-from-shell/" class="md-nav__link">
        42 creating gke deployments from shell
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../43-setting-up-react/" class="md-nav__link">
        Steps to run react in local environment
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../44-redis-with-gcp-cloud-func/" class="md-nav__link">
        44 redis with gcp cloud func
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    Objectives
  </a>
  
    <nav class="md-nav" aria-label="Objectives">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#activate-cloud-shell" class="md-nav__link">
    Activate cloud shell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-1-create-deployment-manifests-and-deploy-to-the-cluster" class="md-nav__link">
    Task 1. Create deployment manifests and deploy to the cluster
  </a>
  
    <nav class="md-nav" aria-label="Task 1. Create deployment manifests and deploy to the cluster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#connect-to-the-lab-gke-cluster" class="md-nav__link">
    Connect to the lab GKE cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-deployment-manifest" class="md-nav__link">
    Create a deployment manifest
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-2-manually-scale-up-and-down-the-number-of-pods-in-deployments" class="md-nav__link">
    Task 2. Manually scale up and down the number of Pods in deployments
  </a>
  
    <nav class="md-nav" aria-label="Task 2. Manually scale up and down the number of Pods in deployments">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scale-pods-up-and-down-in-the-console" class="md-nav__link">
    Scale Pods up and down in the console
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scale-pods-up-and-down-in-the-shell" class="md-nav__link">
    Scale Pods up and down in the shell
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-3-trigger-a-deployment-rollout-and-a-deployment-rollback" class="md-nav__link">
    Task 3. Trigger a deployment rollout and a deployment rollback
  </a>
  
    <nav class="md-nav" aria-label="Task 3. Trigger a deployment rollout and a deployment rollback">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#trigger-a-deployment-rollout" class="md-nav__link">
    Trigger a deployment rollout
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-the-rollout-history-of-the-deployment" class="md-nav__link">
    View the rollout history of the deployment.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trigger-a-deployment-rollback" class="md-nav__link">
    Trigger a deployment rollback
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-service-types-in-the-manifest" class="md-nav__link">
    Define service types in the manifest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-the-loadbalancer-creation" class="md-nav__link">
    Verify the LoadBalancer creation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#task-5-perform-a-canary-deployment" class="md-nav__link">
    Task 5. Perform a canary deployment
  </a>
  
    <nav class="md-nav" aria-label="Task 5. Perform a canary deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#session-affinity" class="md-nav__link">
    Session affinity
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="creating-google-kubernetes-engine-deployments">Creating Google Kubernetes Engine Deployments</h1>
<h2 id="objectives">Objectives</h2>
<p>Create deployment manifests, deploy to cluster, and verify Pod rescheduling as nodes are disabled</p>
<p>Trigger manual scaling up and down of Pods in deployments</p>
<p>Trigger deployment rollout (rolling update to new version) and rollbacks</p>
<p>Perform a Canary deployment</p>
<h3 id="activate-cloud-shell">Activate cloud shell</h3>
<p>Google Cloud Shell is a virtual machine that is loaded with development tools. It offers a persistent 5GB home directory and runs on the Google Cloud. Google Cloud Shell provides command-line access to your GCP resources.</p>
<p>This can be activated from the Cloud shell button on the GCP top right toolbar.</p>
<p><code>gcloud</code> is the command-line tool for Google Cloud Platform. It comes pre-installed on Cloud Shell and supports tab-completion.</p>
<p>list the active account name with this command:</p>
<pre><code>gcloud auth list
</code></pre>
<p>list the project ID with this command:</p>
<pre><code>gcloud config list project
</code></pre>
<h3 id="task-1-create-deployment-manifests-and-deploy-to-the-cluster">Task 1. Create deployment manifests and deploy to the cluster</h3>
<p>In this task, you create a deployment manifest for a Pod inside the cluster.</p>
<h4 id="connect-to-the-lab-gke-cluster">Connect to the lab GKE cluster</h4>
<p>In Cloud Shell, type the following command to set the environment variable for the zone and cluster name.</p>
<pre><code>export my_zone=us-central1-a
export my_cluster=standard-cluster-1
</code></pre>
<p>Configure kubectl tab completion in Cloud Shell.</p>
<pre><code>source &lt;(kubectl completion bash)
</code></pre>
<p>In Cloud Shell, configure access to your cluster for the kubectl command-line tool, using the following command:</p>
<pre><code>gcloud container clusters get-credentials $my_cluster --zone $my_zone
</code></pre>
<p>In Cloud Shell enter the following command to clone the repository to the lab Cloud Shell.</p>
<pre><code>git clone https://github.com/GoogleCloudPlatform/training-data-analyst
</code></pre>
<p>Create a soft link as a shortcut to the working directory.</p>
<pre><code>ln -s ~/training-data-analyst/courses/ak8s/v1.1 ~/ak8s
</code></pre>
<p>Change to the directory that contains the sample files for this lab.</p>
<pre><code>cd ~/ak8s/Deployments/
</code></pre>
<h4 id="create-a-deployment-manifest">Create a deployment manifest</h4>
<p>You will create a deployment using a sample deployment manifest called nginx-deployment.yaml that has been provided for you. This deployment is configured to run three Pod replicas with a single nginx container in each Pod listening on TCP port 80.</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80
</code></pre>
<p>To deploy your manifest, execute the following command:</p>
<pre><code>kubectl apply -f ./nginx-deployment.yaml
</code></pre>
<p>To view a list of deployments, execute the following command:</p>
<pre><code>kubectl get deployments
</code></pre>
<p>The output should look like this example.</p>
<p>Output (do not copy)</p>
<pre><code>NAME               READY      UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   0/3        3            0           3s
</code></pre>
<p>Wait a few seconds, and repeat the command until the number listed for CURRENT deployments reported by the command matches the number of DESIRED deployments.
The final output should look like the example.</p>
<p>Output (do not copy)</p>
<pre><code>NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3/3     3            3           42s
</code></pre>
<h3 id="task-2-manually-scale-up-and-down-the-number-of-pods-in-deployments">Task 2. Manually scale up and down the number of Pods in deployments</h3>
<p>Sometimes, you want to shut down a Pod instance. Other times, you want ten Pods running. In Kubernetes, you can scale a specific Pod to the desired number of instances. To shut them down, you scale to zero.</p>
<p>In this task, you scale Pods up and down in the Google Cloud Console and Cloud Shell.</p>
<h4 id="scale-pods-up-and-down-in-the-console">Scale Pods up and down in the console</h4>
<p>Switch to the Google Cloud Console tab.
On the Navigation menu, click Kubernetes Engine &gt; Workloads.
Click nginx-deployment (your deployment) to open the Deployment details page.
At the top, click ACTIONS &gt; Scale.
Type 1 and click SCALE.
This action scales down your cluster. You should see the Pod status being updated under Managed Pods. You might have to click Refresh.</p>
<h4 id="scale-pods-up-and-down-in-the-shell">Scale Pods up and down in the shell</h4>
<p>Switch back to the Cloud Shell browser tab.</p>
<p>In the Cloud Shell, to view a list of Pods in the deployments, execute the following command:</p>
<pre><code>kubectl get deployments 
</code></pre>
<p>Output (do not copy)</p>
<pre><code>NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   1/1     1            1           3m
</code></pre>
<p>To scale the Pod back up to three replicas, execute the following command:</p>
<pre><code>kubectl scale --replicas=3 deployment nginx-deployment
</code></pre>
<p>To view a list of Pods in the deployments, execute the following command:</p>
<pre><code>kubectl get deployments
</code></pre>
<h3 id="task-3-trigger-a-deployment-rollout-and-a-deployment-rollback">Task 3. Trigger a deployment rollout and a deployment rollback</h3>
<p>A deployment's rollout is triggered if and only if the deployment's Pod template (that is, .spec.template) is changed, for example, if the labels or container images of the template are updated. Other updates, such as scaling the deployment, do not trigger a rollout.</p>
<p>In this task, you trigger deployment rollout, and then you trigger deployment rollback.</p>
<h4 id="trigger-a-deployment-rollout">Trigger a deployment rollout</h4>
<p>To update the version of nginx in the deployment, execute the following command:</p>
<pre><code>kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1 --record
</code></pre>
<p>This updates the container image in your Deployment to nginx v1.9.1. The <code>record</code> flag is being deprecated.</p>
<p>To view the rollout status, execute the following command:</p>
<pre><code>kubectl rollout status deployment.v1.apps/nginx-deployment
</code></pre>
<p>The output should look like the example.</p>
<p>Output (do not copy)</p>
<pre><code>Waiting for rollout to finish: 1 out of 3 new replicas updated...
Waiting for rollout to finish: 1 out of 3 new replicas updated...
Waiting for rollout to finish: 1 out of 3 new replicas updated...
Waiting for rollout to finish: 2 out of 3 new replicas updated...
Waiting for rollout to finish: 2 out of 3 new replicas updated...
Waiting for rollout to finish: 2 out of 3 new replicas updated...
Waiting for rollout to finish: 1 old replicas pending termination...
Waiting for rollout to finish: 1 old replicas pending termination...
deployment &quot;nginx-deployment&quot; successfully rolled out
</code></pre>
<p>To verify the change, get the list of deployments.</p>
<pre><code>kubectl get deployments
</code></pre>
<p>The output should look like the example.</p>
<p>Output (do not copy)</p>
<pre><code>NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3/3     3            3           6m
</code></pre>
<h4 id="view-the-rollout-history-of-the-deployment">View the rollout history of the deployment.</h4>
<pre><code>kubectl rollout history deployment nginx-deployment
</code></pre>
<p>The output should look like the example. Your output might not be an exact match.</p>
<p>Output (do not copy)</p>
<pre><code>deployments &quot;nginx-deployment&quot;
REVISION  CHANGE-CAUSE
1         &lt;none&gt;
2         kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1 --record=true
</code></pre>
<h4 id="trigger-a-deployment-rollback">Trigger a deployment rollback</h4>
<p>To roll back an object's rollout, you can use the kubectl rollout undo command.</p>
<p>To roll back to the previous version of the nginx deployment, execute the following command:</p>
<pre><code>kubectl rollout undo deployments nginx-deployment
</code></pre>
<p>View the updated rollout history of the deployment.</p>
<pre><code>kubectl rollout history deployment nginx-deployment
</code></pre>
<p>The output should look like the example. Your output might not be an exact match.</p>
<p>Output (do not copy)</p>
<pre><code>deployments &quot;nginx-deployment&quot;
REVISION  CHANGE-CAUSE
2         kubectl set image deployment.v1.apps/nginx-deployment nginx=nginx:1.9.1 --record=true
3         &lt;none&gt;
</code></pre>
<p>View the details of the latest deployment revision</p>
<pre><code>kubectl rollout history deployment/nginx-deployment --revision=3
</code></pre>
<p>The output should look like the example. Your output might not be an exact match but it will show that the current revision has rolled back to nginx:1.7.9.</p>
<p>Output (do not copy)</p>
<pre><code>deployments &quot;nginx-deployment&quot; with revision #3
Pod Template:
  Labels:       app=nginx
        pod-template-hash=3123191453
  Containers:
   nginx:
    Image:      nginx:1.7.9
    Port:       80/TCP
    Host Port:  0/TCP
    Environment:        &lt;none&gt;
    Mounts:     &lt;none&gt;
  Volumes:      &lt;none&gt;
</code></pre>
<h4 id="define-service-types-in-the-manifest">Define service types in the manifest</h4>
<p>A manifest file called service-nginx.yaml that deploys a LoadBalancer service type has been provided for you. This service is configured to distribute inbound traffic on TCP port 60000 to port 80 on any containers that have the label app: nginx.</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  type: LoadBalancer
  selector:
    app: nginx
  ports:
  - protocol: TCP
    port: 60000
    targetPort: 80
</code></pre>
<p>In the Cloud Shell, to deploy your manifest, execute the following command:</p>
<pre><code>kubectl apply -f ./service-nginx.yaml
</code></pre>
<p>This manifest defines a service and applies it to Pods that correspond to the selector. In this case, the manifest is applied to the nginx container that you deployed in task 1. This service also applies to any other Pods with the app: nginx label, including any that are created after the service.</p>
<h4 id="verify-the-loadbalancer-creation">Verify the LoadBalancer creation</h4>
<p>To view the details of the nginx service, execute the following command:</p>
<pre><code>kubectl get service nginx
</code></pre>
<p>The output should look like the example.</p>
<p>Output (do not copy)</p>
<pre><code>NAME      CLUSTER_IP      EXTERNAL_IP      PORT(S)   SELECTOR    AGE
nginx     10.X.X.X        X.X.X.X          60000/TCP    run=nginx   1m
</code></pre>
<p>When the external IP appears, open http://[EXTERNAL_IP]:60000/ in a new browser tab to see the server being served through network load balancing.</p>
<p>It may take a few seconds before the ExternalIP field is populated for your service. This is normal. Just re-run the kubectl get services nginx command every few seconds until the field is populated.</p>
<h3 id="task-5-perform-a-canary-deployment">Task 5. Perform a canary deployment</h3>
<p>A canary deployment is a separate deployment used to test a new version of your application. A single service targets both the canary and the normal deployments. And it can direct a subset of users to the canary version to mitigate the risk of new releases. The manifest file nginx-canary.yaml that is provided for you deploys a single pod running a newer version of nginx than your main deployment. In this task, you create a canary deployment using this new deployment file.</p>
<pre><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-canary
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
        track: canary
        Version: 1.9.1
    spec:
      containers:
      - name: nginx
        image: nginx:1.9.1
        ports:
        - containerPort: 80
</code></pre>
<p>The manifest for the nginx Service you deployed in the previous task uses a label selector to target the Pods with the app: nginx label. Both the normal deployment and this new canary deployment have the app: nginx label. Inbound connections will be distributed by the service to both the normal and canary deployment Pods. The canary deployment has fewer replicas (Pods) than the normal deployment, and thus it is available to fewer users than the normal deployment.</p>
<p>Create the canary deployment based on the configuration file.</p>
<pre><code>kubectl apply -f nginx-canary.yaml
</code></pre>
<p>When the deployment is complete, verify that both the nginx and the nginx-canary deployments are present.</p>
<pre><code>kubectl get deployments
</code></pre>
<p>Switch back to the browser tab that is connected to the external LoadBalancer service ip and refresh the page. You should continue to see the standard Welcome to nginx page.</p>
<p>Switch back to the Cloud Shell and scale down the primary deployment to 0 replicas.</p>
<pre><code>kubectl scale --replicas=0 deployment nginx-deployment
</code></pre>
<p>Verify that the only running replica is now the Canary deployment:</p>
<pre><code>kubectl get deployments
</code></pre>
<p>Switch back to the browser tab that is connected to the external LoadBalancer service ip and refresh the page. You should continue to see the standard Welcome to nginx page showing that the Service is automatically balancing traffic to the canary deployment.</p>
<h4 id="session-affinity">Session affinity</h4>
<p>The service configuration used in the lab does not ensure that all requests from a single client will always connect to the same Pod. Each request is treated separately and can connect to either the normal nginx deployment or to the nginx-canary deployment. This potential to switch between different versions may cause problems if there are significant changes in functionality in the canary release. To prevent this you can set the sessionAffinity field to ClientIP in the specification of the service if you need a client's first request to determine which Pod will be used for all subsequent connections.</p>
<p>For example:</p>
<pre><code>apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  type: LoadBalancer
  sessionAffinity: ClientIP
  selector:
    app: nginx
  ports:
  - protocol: TCP
    port: 60000
    targetPort: 80
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.2a6f1dda.min.js"></script>
      
    
  </body>
</html>