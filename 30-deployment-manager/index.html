<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://tanviralam.com/30-deployment-manager/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Automating the Deployment of Infrastructure Using Deployment Manager - Tanvir's Notes</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Automating the Deployment of Infrastructure Using Deployment Manager";
        var mkdocs_page_input_path = "30-deployment-manager.md";
        var mkdocs_page_url = "/30-deployment-manager/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Tanvir's Notes
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Welcome to MkDocs</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../01-linear-algebra-machine-learning/">Linear Algebra for Machine Learning</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../02-git_workflow/">Creating a repo</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../03-python-virtual-environments-with-jupyter/">What are Python Virtual Environments</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../04-ecommerce-payments/">Structure</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../05-pubsub-google-clouds/">05 pubsub google clouds</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../07-tmux/">Tmux</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../08-using-system-clipboard-in-vim/">08 using system clipboard in vim</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../09-padi-openwater-sec1/">09 padi openwater sec1</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../10-padi-openwater-sec2/">10 padi openwater sec2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../11-padi-openwater-sec3/">11 padi openwater sec3</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../12-padi-openwater-sec3-problem-management/">12 padi openwater sec3 problem management</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../13-padi-openwater-sec3-equipment3/">13 padi openwater sec3 equipment3</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../14-padi-openwater-sec3-skills2/">14 padi openwater sec3 skills2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../15-padi-openwater-sec4-equipment4/">15 padi openwater sec4 equipment4</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../16-padi-openwater-sec4-diver4/">16 padi openwater sec4 diver4</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../17-padi-openwater-sec4-divecomputers1/">17 padi openwater sec4 divecomputers1</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../18-padi-openwater-sec4-skills4/">18 padi openwater sec4 skills4</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../19-padi-openwater-sec5-divecomputers2/">19 padi openwater sec5 divecomputers2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../20-padi-openwater-sec5-diver5/">20 padi openwater sec5 diver5</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../21-padi-sec5-skills5/">21 padi sec5 skills5</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../22-ubuntu-bluetooth-uninstall-reinstall/">22 ubuntu bluetooth uninstall reinstall</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../23-advanced-big-query/">Objectives</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../24-freedomticket-week1-intro-to-selling/">24 freedomticket week1 intro to selling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../25-gcp-essential-infrastructure-cloud-sql/">Implementing Cloud SQL</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../26-gcp-essential-infrastructure-monitoring/">Resource Monitoring</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../27-gcp-elastic-cloud-vpn/">Virtual Private Networks (VPN)</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../28-http-load-balancer/">Configuring an HTTP Load Balancer with Autoscaling</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../29-internal-load-balancer/">Configuring an Internal Load Balancer</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Automating the Deployment of Infrastructure Using Deployment Manager</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#objectives">Objectives</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-1-configure-the-network">Task 1. Configure the network</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#verify-that-the-deployment-manager-api-is-enabled">Verify that the Deployment Manager API is enabled</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#start-the-cloud-shell-editor">Start the Cloud Shell Editor</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#create-the-auto-mode-network-configuration">Create the auto mode network configuration</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-2-configure-the-firewall-rule">Task 2. Configure the firewall rule</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#add-the-firewall-rule-to-the-configuration">Add the firewall rule to the configuration</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-3-create-a-template-for-vm-instances">Task 3. Create a template for VM instances</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#create-the-vm-instance-template">Create the VM instance template</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#deploy-the-configuration">Deploy the configuration</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#task-5-verify-your-deployment">Task 5. Verify your deployment</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../31-aws-session/">31 aws session</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../32-gcp-cloud-build/">32 gcp cloud build</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../33-gcp-deploying-kubernetes/">33 gcp deploying kubernetes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../34-gcp-creating-kubernetes-engine-deployments/">Creating Google Kubernetes Engine Deployments</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../35-gcp-persistent-volume-for-gke/">Configuring persistent volume for Google Kubernetes Engine</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../36-gcloud-basics/">Basic gcloud commands</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../37-migrate-for-anthos/">37 migrate for anthos</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../38-kubectl-basics/">38 kubectl basics</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../39-creating-gke-deployments/">39 creating gke deployments</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../40-data-reliability-conference/">40 data reliability conference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../41-persistent-storage-gke/">Persistent storage in GKE</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../42-creating-gke-deployments-from-shell/">42 creating gke deployments from shell</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../43-setting-up-react/">Steps to run react in local environment</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../44-redis-with-gcp-cloud-func/">44 redis with gcp cloud func</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Tanvir's Notes</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Automating the Deployment of Infrastructure Using Deployment Manager</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="automating-the-deployment-of-infrastructure-using-deployment-manager">Automating the Deployment of Infrastructure Using Deployment Manager</h1>
<h2 id="overview">Overview</h2>
<p>Deployment Manager is an infrastructure deployment service that automates the creation and management of Google Cloud resources. Write flexible template and configuration files and use them to create deployments that have a variety of Cloud Platform services, such as Cloud Storage, Compute Engine, and Cloud SQL, configured to work together.</p>
<p>In this lab, you create a Deployment Manager configuration with a template to automate the deployment of Google Cloud infrastructure. Specifically, you deploy one auto mode network with a firewall rule and two VM instances</p>
<h2 id="objectives">Objectives</h2>
<p>Create a configuration for an auto mode network</p>
<p>Create a configuration for a firewall rule</p>
<p>Create a template for VM instances</p>
<p>Create and deploy a configuration</p>
<p>Verify the deployment of a configuration</p>
<h2 id="task-1-configure-the-network">Task 1. Configure the network</h2>
<p>A configuration describes all the resources you want for a single deployment.</p>
<h3 id="verify-that-the-deployment-manager-api-is-enabled">Verify that the Deployment Manager API is enabled</h3>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click APIs &amp; services &gt; Library.</p>
<p>In the search bar, type Deployment Manager, and click the result for Cloud Deployment Manager V2 API.</p>
<h3 id="start-the-cloud-shell-editor">Start the Cloud Shell Editor</h3>
<p>To write the configuration and the template, you use the Cloud Shell Editor.</p>
<p>In the Cloud Console, click Activate Cloud Shell (Cloud Shell).</p>
<p>If prompted, click Continue.</p>
<p>Run the following commands:</p>
<p>mkdir dminfra
cd dminfra</p>
<p>In Cloud Shell, click Open Editor (Cloud Shell Editor).</p>
<p>In the left pane of the code editor, expand the dminfra folder.</p>
<h3 id="create-the-auto-mode-network-configuration">Create the auto mode network configuration</h3>
<p>A configuration is a file written in YAML syntax that lists each of the resources you want to create and their respective resource properties. A configuration must contain a resources: section followed by the list of resources to create. Start the configuration with the mynetwork resource.</p>
<p>To create a new file, click File &gt; New File.</p>
<p>Name the new file config.yaml, and then open it.</p>
<p>Copy the following base code into config.yaml:</p>
<pre><code>resources:
# Create the auto-mode network
- name: [RESOURCE_NAME]
  type: [RESOURCE_TYPE]
  properties:
    #RESOURCE properties go here
</code></pre>
<p>In config.yaml, replace <code>[RESOURCE_NAME]</code> with mynetwork</p>
<p>To get a list of all available network resource types in Google Cloud, run the following command in Cloud Shell:</p>
<pre><code>gcloud deployment-manager types list | grep network
</code></pre>
<p>The output should look like this (do not copy; this is example output):</p>
<pre><code>compute.beta.subnetwork
compute.alpha.subnetwork
compute.v1.subnetwork
compute.beta.network
compute.v1.network
compute.alpha.network
</code></pre>
<p>Locate compute.v1.network, which is the type needed to create a VPC network using Deployment Manager.</p>
<p>By definition, an auto mode network automatically creates a subnetwork in each region. </p>
<h2 id="task-2-configure-the-firewall-rule">Task 2. Configure the firewall rule</h2>
<p>In order to allow ingress traffic instances in mynetwork, you need to create a firewall rule.</p>
<h3 id="add-the-firewall-rule-to-the-configuration">Add the firewall rule to the configuration</h3>
<p>Add a firewall rule that allows HTTP, SSH, RDP, and ICMP traffic on mynetwork.</p>
<p>To get a list of all available firewall rule resource types in Google Cloud, run the following command in Cloud Shell:</p>
<pre><code>gcloud deployment-manager types list | grep firewall
</code></pre>
<p>The output should look like this (do not copy; this is example output):</p>
<pre><code>compute.v1.firewall
compute.alpha.firewall
compute.beta.firewall
</code></pre>
<p>Locate compute.v1.firewall, which is the type needed to create a firewall rule using Deployment Manager.</p>
<p>The final <code>config.yaml</code></p>
<pre><code>imports:
- path: instance-template.jinja

resources:
# Create the auto-mode network
- name: mynetwork
  type: compute.v1.network
  properties:
    autoCreateSubnetworks: true
# Create the firewall rule
- name: mynetwork-allow-http-ssh-rdp-icmp
  type: compute.v1.firewall
  properties:
    network: $(ref.mynetwork.selfLink)
    sourceRanges: [&quot;0.0.0.0/0&quot;]
    allowed:
    - IPProtocol: TCP
      ports: [22, 80, 3389]
    - IPProtocol: ICMP

# Create the mynet-us-vm instance
- name: mynet-us-vm
  type: instance-template.jinja
  properties:
    zone: us-central1-a
    machineType: n1-standard-1
    network: $(ref.mynetwork.selfLink)
    subnetwork: regions/us-central1/subnetworks/mynetwork

# Create the mynet-eu-vm instance
- name: mynet-eu-vm
  type: instance-template.jinja
  properties:
    zone: europe-west1-d
    machineType: n1-standard-1
    network: $(ref.mynetwork.selfLink)  
    subnetwork: regions/europe-west1/subnetworks/mynetwork
</code></pre>
<h2 id="task-3-create-a-template-for-vm-instances">Task 3. Create a template for VM instances</h2>
<p>Deployment Manager allows you to use Python or Jinja2 templates to parameterize your configuration. This allows you to reuse common deployment paradigms such as networks, firewall rules, and VM instances.</p>
<h3 id="create-the-vm-instance-template">Create the VM instance template</h3>
<p>Because you will be creating two similar VM instances, create a VM instance template.</p>
<p>To create a new file, click File &gt; New File.</p>
<p>Name the new file instance-template.jinja, and then open it.</p>
<p>Properties to define:</p>
<p>machineType: Machine type and zone
zone: Instance zone
networkInterfaces: Network and subnetwork that VM is attached to
accessConfigs: Required to give the instance a public IP address (required in this lab). To create instances with only an internal IP address, remove the accessConfigs section.
disks: The boot disk, its name and image
Most properties are defined as template properties, which you will provide values for from the top-level configuration (config.yaml).</p>
<p>To get a list of all available instance resource types in Google Cloud, run the following command in Cloud Shell:</p>
<pre><code>gcloud deployment-manager types list | grep instance
</code></pre>
<p>Locate compute.v1.instance, which is the type needed to create a VM instance using Deployment Manager.</p>
<p>Final <code>instance-template.jinja</code>:</p>
<pre><code> resources:
- name: {{ env[&quot;name&quot;] }}
  type: compute.v1.instance  
  properties:
     machineType: zones/{{ properties[&quot;zone&quot;] }}/machineTypes/{{ properties[&quot;machineType&quot;] }}
     zone: {{ properties[&quot;zone&quot;] }}
     networkInterfaces:
      - network: {{ properties[&quot;network&quot;] }}
        subnetwork: {{ properties[&quot;subnetwork&quot;] }}
        accessConfigs:
        - name: External NAT
          type: ONE_TO_ONE_NAT
     disks:
      - deviceName: {{ env[&quot;name&quot;] }}
        type: PERSISTENT
        boot: true
        autoDelete: true
        initializeParams:
          sourceImage: https://www.googleapis.com/compute/v1/projects/debian-cloud/global/images/family/debian-9
</code></pre>
<h2 id="deploy-the-configuration">Deploy the configuration</h2>
<pre><code>gcloud deployment-manager deployments create dminfra --config=config.yaml --preview
</code></pre>
<pre><code>gcloud deployment-manager deployments update dminfra
</code></pre>
<p>Or, directly deploy:</p>
<pre><code>gcloud deployment-manager deployments create dminfra --config=config.yaml
</code></pre>
<p>Delete using:</p>
<pre><code>gcloud deployment-manager deployments delete dminfra
</code></pre>
<h2 id="task-5-verify-your-deployment">Task 5. Verify your deployment</h2>
<p>Verify your network in the Cloud Console</p>
<p>In the Cloud Console, on the Navigation menu (Navigation menu), click VPC network &gt; VPC networks.</p>
<p>View the mynetwork VPC network with a subnetwork in every region.</p>
<p>On the Navigation menu, click VPC network &gt; Firewall.</p>
<p>Sort the firewall rules by Network.</p>
<p>View the mynetwork-allow-http-ssh-rdp-icmp firewall rule for mynetwork.</p>
<p>Verify your VM instances in the Cloud Console</p>
<p>On the Navigation menu (Navigation menu), click Compute Engine &gt; VM instances.</p>
<p>View the mynet-us-vm and mynet-eu-vm instances.</p>
<p>Note the internal IP address for mynet-eu-vm.</p>
<p>For mynet-us-vm, click SSH to launch a terminal and connect.</p>
<p>To test connectivity to mynet-eu-vm's internal IP address, run the following command in the SSH terminal (replacing mynet-eu-vm's internal IP address with the value noted earlier):</p>
<pre><code>ping -c 3 &lt;Enter mynet-eu-vm's internal IP here&gt;
</code></pre>
<p>This should work because both VM instances are on the same network and the firewall rule allows ICMP traffic!</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../29-internal-load-balancer/" class="btn btn-neutral float-left" title="Configuring an Internal Load Balancer"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../31-aws-session/" class="btn btn-neutral float-right" title="31 aws session">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../29-internal-load-balancer/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../31-aws-session/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
